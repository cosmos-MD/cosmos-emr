// ../node_modules/@medplum/core/dist/esm/index.mjs
var ge = class {
  constructor(e, t) {
    this.operator = e;
    this.child = t;
  }
  toString() {
    return `${this.operator}(${this.child.toString()})`;
  }
};
var $ = class {
  constructor(e, t, n) {
    this.operator = e;
    this.left = t;
    this.right = n;
  }
  toString() {
    return `${this.left.toString()} ${this.operator} ${this.right.toString()}`;
  }
};
var xe = class {
  constructor() {
    this.prefixParselets = {};
    this.infixParselets = {};
  }
  registerInfix(e, t) {
    return this.infixParselets[e] = t, this;
  }
  registerPrefix(e, t) {
    return this.prefixParselets[e] = t, this;
  }
  prefix(e, t, n) {
    return this.registerPrefix(e, { parse(i, o) {
      let s = i.consumeAndParse(t);
      return n(o, s);
    } });
  }
  infixLeft(e, t, n) {
    return this.registerInfix(e, { parse(i, o, s) {
      let a = i.consumeAndParse(t);
      return n(o, s, a);
    }, precedence: t });
  }
  construct(e) {
    return new rt(e, this.prefixParselets, this.infixParselets);
  }
};
var rt = class {
  constructor(e, t, n) {
    this.tokens = e, this.prefixParselets = t, this.infixParselets = n;
  }
  hasMore() {
    return this.tokens.length > 0;
  }
  match(e) {
    var _a2;
    return ((_a2 = this.peek()) == null ? void 0 : _a2.id) !== e ? false : (this.consume(), true);
  }
  consumeAndParse(e = 1 / 0) {
    let t = this.consume(), n = this.prefixParselets[t.id];
    if (!n)
      throw Error(`Parse error at "${t.value}" (line ${t.line}, column ${t.column}). No matching prefix parselet.`);
    let i = n.parse(this, t);
    for (; e > this.getPrecedence(); ) {
      let o = this.consume();
      i = this.getInfixParselet(o).parse(this, i, o);
    }
    return i;
  }
  getPrecedence() {
    let e = this.peek();
    if (!e)
      return 1 / 0;
    let t = this.getInfixParselet(e);
    return t ? t.precedence : 1 / 0;
  }
  consume(e, t) {
    var _a2, _b;
    if (!this.tokens.length)
      throw Error("Cant consume unknown more tokens.");
    if (e && ((_a2 = this.peek()) == null ? void 0 : _a2.id) !== e) {
      let n = this.peek();
      throw Error(`Expected ${e} but got "${n.id}" at line ${n.line} column ${n.column}.`);
    }
    if (t && ((_b = this.peek()) == null ? void 0 : _b.value) !== t) {
      let n = this.peek();
      throw Error(`Expected "${t}" but got "${n.value}" at line ${n.line} column ${n.column}.`);
    }
    return this.tokens.shift();
  }
  peek() {
    return this.tokens.length > 0 ? this.tokens[0] : void 0;
  }
  removeComments() {
    this.tokens = this.tokens.filter((e) => e.id !== "Comment");
  }
  getInfixParselet(e) {
    return this.infixParselets[e.id === "Symbol" ? e.value : e.id];
  }
};
function G(r4) {
  let e = se(r4), t = hn(r4);
  return t === e ? { reference: e } : { reference: e, display: t };
}
function se(r4) {
  return ae(r4) ? r4.reference : `${r4.resourceType}/${r4.id}`;
}
function Kt(r4) {
  if (r4)
    return ae(r4) ? r4.reference.split("/")[1] : r4.id;
}
function wo(r4) {
  if ((r4 == null ? void 0 : r4.reference) === void 0)
    return;
  let [e, t] = r4.reference.split("/");
  if (!(e === "" || t === "" || t === void 0))
    return [e, t];
}
function mn(r4) {
  return r4.resourceType === "Patient" || r4.resourceType === "Practitioner" || r4.resourceType === "RelatedPerson";
}
function hn(r4) {
  var _a2;
  if (mn(r4)) {
    let e = yn(r4);
    if (e)
      return e;
  }
  if (r4.resourceType === "Device") {
    let e = gn(r4);
    if (e)
      return e;
  }
  return r4.resourceType === "Observation" && "code" in r4 && ((_a2 = r4.code) == null ? void 0 : _a2.text) ? r4.code.text : r4.resourceType === "User" && r4.email ? r4.email : "name" in r4 && r4.name && typeof r4.name == "string" ? r4.name : se(r4);
}
function yn(r4) {
  let e = r4.name;
  if (e && e.length > 0)
    return Re(e[0]);
}
function gn(r4) {
  let e = r4.deviceName;
  if (e && e.length > 0)
    return e[0].name;
}
function Io(r4) {
  if (!("photo" in r4))
    return;
  let e = r4.photo;
  if (e)
    if (Array.isArray(e))
      for (let t of e) {
        let n = Ht(t);
        if (n)
          return n;
      }
    else
      return Ht(e);
}
function Ht(r4) {
  if (r4.url && r4.contentType && r4.contentType.startsWith("image/"))
    return r4.url;
}
function ko(r4) {
  return r4 ? new Date(r4) : void 0;
}
function Te(r4, e) {
  let t = new Date(r4);
  t.setUTCHours(0, 0, 0, 0);
  let n = e ? new Date(e) : /* @__PURE__ */ new Date();
  n.setUTCHours(0, 0, 0, 0);
  let i = t.getUTCFullYear(), o = t.getUTCMonth(), s = t.getUTCDate(), a = n.getUTCFullYear(), c = n.getUTCMonth(), f = n.getUTCDate(), p = a - i;
  (c < o || c === o && f < s) && p--;
  let q = a * 12 + c - (i * 12 + o);
  f < s && q--;
  let fn = Math.floor((n.getTime() - t.getTime()) / (1e3 * 60 * 60 * 24));
  return { years: p, months: q, days: fn };
}
function Oo(r4, e) {
  let { years: t, months: n, days: i } = Te(r4, e);
  return t >= 2 ? t.toString().padStart(3, "0") + "Y" : n >= 1 ? n.toString().padStart(3, "0") + "M" : i.toString().padStart(3, "0") + "D";
}
function Vo(r4) {
  let e = {};
  return Wt(r4.item, e), e;
}
function Wt(r4, e) {
  if (r4)
    for (let t of r4)
      t.linkId && t.answer && t.answer.length > 0 && (e[t.linkId] = t.answer[0]), Wt(t.item, e);
}
function Do(r4) {
  let e = {};
  return Gt(r4.item, e), e;
}
function Gt(r4, e) {
  if (r4)
    for (let t of r4)
      t.linkId && t.answer && t.answer.length > 0 && (e[t.linkId] = t.answer), Gt(t.item, e);
}
function No(r4, e) {
  let t = r4.identifier;
  if (!t)
    return;
  let n = Array.isArray(t) ? t : [t];
  for (let i of n)
    if (i.system === e)
      return i.value;
}
function Fo(r4, e, t) {
  let n = r4.identifier;
  if (!n) {
    r4.identifier = [{ system: e, value: t }];
    return;
  }
  for (let i of n)
    if (i.system === e) {
      i.value = t;
      return;
    }
  n.push({ system: e, value: t });
}
function _o(r4, ...e) {
  var _a2;
  let t = r4;
  for (let n = 0; n < e.length && t; n++)
    t = (_a2 = t == null ? void 0 : t.extension) == null ? void 0 : _a2.find((i) => i.url === e[n]);
  return t == null ? void 0 : t.valueString;
}
function Uo(r4, ...e) {
  var _a2;
  let t = r4;
  for (let n = 0; n < e.length && t; n++)
    t = (_a2 = t == null ? void 0 : t.extension) == null ? void 0 : _a2.find((i) => i.url === e[n]);
  return t;
}
function zt(r4, e) {
  return JSON.stringify(r4, xn, e ? 2 : void 0);
}
function xn(r4, e) {
  return !Tn(r4) && E(e) ? void 0 : e;
}
function Tn(r4) {
  return !!/\d+$/.exec(r4);
}
function E(r4) {
  if (r4 == null)
    return true;
  let e = typeof r4;
  return e === "string" && r4 === "" || e === "object" && Object.keys(r4).length === 0;
}
function ve(r4, e, t) {
  return r4 === e || E(r4) && E(e) ? true : E(r4) || E(e) ? false : Array.isArray(r4) && Array.isArray(e) ? vn(r4, e) : Array.isArray(r4) || Array.isArray(e) ? false : j(r4) && j(e) ? Sn(r4, e, t) : (j(r4) || j(e), false);
}
function vn(r4, e) {
  if (r4.length !== e.length)
    return false;
  for (let t = 0; t < r4.length; t++)
    if (!ve(r4[t], e[t]))
      return false;
  return true;
}
function Sn(r4, e, t) {
  let n = /* @__PURE__ */ new Set();
  Object.keys(r4).forEach((i) => n.add(i)), Object.keys(e).forEach((i) => n.add(i)), t === "meta" && (n.delete("versionId"), n.delete("lastUpdated"), n.delete("author"));
  for (let i of n) {
    let o = r4[i], s = e[i];
    if (!ve(o, s, i))
      return false;
  }
  return true;
}
function Se(r4, e) {
  return E(r4) ? true : E(e) ? false : Array.isArray(r4) && Array.isArray(e) ? En(r4, e) : Array.isArray(r4) || Array.isArray(e) ? false : j(r4) && j(e) ? bn(r4, e) : j(r4) || j(e) ? false : r4 === e;
}
function En(r4, e) {
  return r4.every((t) => e.some((n) => Se(t, n)));
}
function bn(r4, e) {
  return Object.entries(r4).every(([t, n]) => t in e && Se(n, e[t]));
}
function it(r4) {
  return JSON.parse(JSON.stringify(r4));
}
function Lo(r4) {
  return !!/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/i.exec(r4);
}
function j(r4) {
  return r4 !== null && typeof r4 == "object";
}
function Jt(r4) {
  return r4.every((e) => typeof e == "string");
}
var Yt = [];
for (let r4 = 0; r4 < 256; r4++)
  Yt.push(r4.toString(16).padStart(2, "0"));
function Xt(r4) {
  let e = new Uint8Array(r4), t = new Array(e.length);
  for (let n = 0; n < e.length; n++)
    t[n] = Yt[e[n]];
  return t.join("");
}
function Zt(r4) {
  let e = new Uint8Array(r4), t = [];
  for (let n = 0; n < e.length; n++)
    t[n] = String.fromCharCode(e[n]);
  return window.btoa(t.join(""));
}
function P(r4) {
  return r4.charAt(0).toUpperCase() + r4.substring(1);
}
function Ee(r4) {
  return r4 === r4.toLowerCase() && r4 !== r4.toUpperCase();
}
function nt(r4, e) {
  var _a2, _b;
  return (_b = (_a2 = r4.coding) == null ? void 0 : _a2.find((t) => t.system === e)) == null ? void 0 : _b.code;
}
function Mo(r4, e, t) {
  r4.coding || (r4.coding = []);
  let n = r4.coding.find((i) => i.system === e);
  n ? n.code = t : r4.coding.push({ system: e, code: t });
}
function Bo(r4, e, t, n) {
  var _a2;
  return (_a2 = r4.qualifiedInterval) == null ? void 0 : _a2.find((i) => {
    var _a3;
    return er(i, e) && An(i, t, (_a3 = r4.quantitativeDetails) == null ? void 0 : _a3.decimalPrecision) && (n === void 0 || i.category === n);
  });
}
function qo(r4, e, t) {
  var _a2;
  return (_a2 = r4.qualifiedInterval) == null ? void 0 : _a2.find((n) => er(n, e) && t.includes(n.condition));
}
function er(r4, e) {
  return Rn(r4, e) && Pn(r4, e);
}
function Rn(r4, e) {
  return !r4.gender || r4.gender === e.gender;
}
function Pn(r4, e) {
  return !r4.age || tr(Te(e.birthDate).years, r4.age);
}
function An(r4, e, t) {
  return !!r4.range && tr(e, r4.range, t);
}
function tr(r4, e, t) {
  var _a2, _b;
  return (((_a2 = e.low) == null ? void 0 : _a2.value) === void 0 || wn(r4, e.low.value, t)) && (((_b = e.high) == null ? void 0 : _b.value) === void 0 || Cn(r4, e.high.value, t));
}
function $o(r4, e) {
  return parseFloat(r4.toFixed(e));
}
function jo(r4, e, t) {
  return V(r4, t) === V(e, t);
}
function Qo(r4, e, t) {
  return V(r4, t) < V(e, t);
}
function Ho(r4, e, t) {
  return V(r4, t) > V(e, t);
}
function Cn(r4, e, t) {
  return V(r4, t) <= V(e, t);
}
function wn(r4, e, t) {
  return V(r4, t) >= V(e, t);
}
function V(r4, e) {
  return e === void 0 ? r4 : Math.round(r4 * Math.pow(10, e));
}
function Ko(r4, e, t) {
  return r4.find((n) => typeof e == "string" ? nt(n.code || {}, t) === e : nt(n.code || {}, t) === nt(e, t));
}
function be(r4) {
  if (r4)
    return Array.isArray(r4) ? r4 : [r4];
}
var ot = (r4) => new Promise((e) => {
  setTimeout(e, r4);
});
function Wo(r4, e, t) {
  let n = [];
  for (let i = 0; i < t - 1; i++) {
    let o = r4.indexOf(e);
    o < 0 && (o = r4.length), n.push(r4.slice(0, o)), r4 = r4.slice(o + e.length);
  }
  return r4 && n.push(r4), n;
}
function Jo(r4, e) {
  let t = [];
  if (r4.line && t.push(...r4.line), r4.city || r4.state || r4.postalCode) {
    let n = [];
    r4.city && n.push(r4.city), r4.state && n.push(r4.state), r4.postalCode && n.push(r4.postalCode), t.push(n.join(", "));
  }
  return r4.use && ((e == null ? void 0 : e.all) || (e == null ? void 0 : e.use)) && t.push("[" + r4.use + "]"), t.join((e == null ? void 0 : e.lineSeparator) ?? ", ").trim();
}
function Re(r4, e) {
  let t = [];
  return r4.prefix && (e == null ? void 0 : e.prefix) !== false && t.push(...r4.prefix), r4.given && t.push(...r4.given), r4.family && t.push(r4.family), r4.suffix && (e == null ? void 0 : e.suffix) !== false && t.push(...r4.suffix), r4.use && ((e == null ? void 0 : e.all) || (e == null ? void 0 : e.use)) && t.push("[" + r4.use + "]"), t.length === 0 && r4.text ? r4.text : t.join(" ").trim();
}
function Yo(r4) {
  let e = [];
  return r4.given && e.push(...r4.given), e.join(" ").trim();
}
function Xo(r4) {
  return r4.family ?? "";
}
function at(r4) {
  return r4 instanceof Date && !isNaN(r4.getTime());
}
function Zo(r4, e, t) {
  if (!r4)
    return "";
  let n = new Date(r4);
  return at(n) ? (n.setUTCHours(0, 0, 0, 0), n.toLocaleDateString(e, { timeZone: "UTC", ...t })) : "";
}
function In(r4, e, t) {
  if (!r4)
    return "";
  let n = /* @__PURE__ */ new Date("2000-01-01T" + r4 + "Z");
  return at(n) ? n.toLocaleTimeString(e, t) : "";
}
function st(r4, e, t) {
  if (!r4)
    return "";
  let n = new Date(r4);
  return at(n) ? n.toLocaleString(e, t) : "";
}
function es(r4, e, t) {
  return !r4 || !r4.start && !r4.end ? "" : st(r4.start, e, t) + " - " + st(r4.end, e, t);
}
var kn = { s: "every second", min: "every minute", h: "hourly", d: "daily", wk: "weekly", mo: "monthly", a: "annually" };
var On = { s: "second", min: "minute", h: "hour", d: "day", wk: "week", mo: "month", a: "year" };
var Vn = { s: "seconds", min: "minutes", h: "hours", d: "days", wk: "weeks", mo: "months", a: "years" };
function ts(r4) {
  if (!r4)
    return "";
  let e = [];
  return Dn(e, r4.repeat), r4.event && e.push(r4.event.map((t) => st(t)).join(", ")), P(e.join(" ").trim());
}
function Dn(r4, e) {
  if (!(e == null ? void 0 : e.periodUnit))
    return;
  let t = e.frequency ?? 1, n = e.period ?? 1, i = e.periodUnit;
  t === 1 && n === 1 ? r4.push(kn[i]) : (t === 1 ? r4.push("once") : r4.push(t + " times"), n === 1 ? r4.push("per " + On[i]) : r4.push("per " + n + " " + Vn[i])), e.dayOfWeek && r4.push("on " + e.dayOfWeek.map(P).join(", ")), e.timeOfDay && r4.push("at " + e.timeOfDay.map((o) => In(o)).join(", "));
}
function rs(r4, e, t = false) {
  if (t && e === void 0)
    throw new Error("Precision must be specified for exclusive ranges");
  let n = (r4 == null ? void 0 : r4.low) && { ...r4.low, comparator: void 0 }, i = (r4 == null ? void 0 : r4.high) && { ...r4.high, comparator: void 0 };
  return (n == null ? void 0 : n.value) === void 0 && (i == null ? void 0 : i.value) === void 0 ? "" : (n == null ? void 0 : n.value) !== void 0 && (i == null ? void 0 : i.value) === void 0 ? t && e !== void 0 ? (n.value = Ln(n.value, e), `> ${z(n, e)}`) : `>= ${z(n, e)}` : (n == null ? void 0 : n.value) === void 0 && (i == null ? void 0 : i.value) !== void 0 ? t && e !== void 0 ? (i.value = Un(i.value, e), `< ${z(i, e)}`) : `<= ${z(i, e)}` : ((n == null ? void 0 : n.unit) === (i == null ? void 0 : i.unit) && (n == null ? true : delete n.unit), `${z(n, e)} - ${z(i, e)}`);
}
function z(r4, e) {
  if (!r4)
    return "";
  let t = [];
  return r4.comparator && (t.push(r4.comparator), t.push(" ")), r4.value !== void 0 && (e !== void 0 ? t.push(r4.value.toFixed(e)) : t.push(r4.value)), r4.unit && (r4.unit !== "%" && t[t.length - 1] !== " " && t.push(" "), t.push(r4.unit)), t.join("").trim();
}
function ns(r4) {
  return (r4 == null ? void 0 : r4.value) === void 0 ? "" : r4.value.toLocaleString(void 0, { style: "currency", currency: r4.currency ?? "USD", currencyDisplay: "narrowSymbol" });
}
function Nn(r4) {
  return r4 ? r4.text ? r4.text : r4.coding ? r4.coding.map((e) => Fn(e)).join(", ") : "" : "";
}
function Fn(r4) {
  return (r4 == null ? void 0 : r4.display) ?? (r4 == null ? void 0 : r4.code) ?? "";
}
function _n(r4) {
  return r4 ? "component" in r4 ? r4.component.map((e) => _n(e)).join(" / ") : r4.valueQuantity ? z(r4.valueQuantity) : r4.valueCodeableConcept ? Nn(r4.valueCodeableConcept) : r4.valueString ? r4.valueString : "" : "";
}
function Un(r4, e, t = 1) {
  return (rr(r4, e) + t) * Math.pow(10, -e);
}
function Ln(r4, e, t = 1) {
  return (rr(r4, e) - t) * Math.pow(10, -e);
}
function rr(r4, e) {
  return e === void 0 ? r4 : Math.round(r4 * Math.pow(10, e));
}
var Mn = { "http://hl7.org/fhirpath/System.String": "string" };
function os(r4) {
  var _a2;
  let e = {};
  return r4.min !== 0 && (e.min = r4.min), r4.max !== 1 && Number.isFinite(r4.max) ? e.max = r4.max : r4.max === Number.POSITIVE_INFINITY && (e.max = Number.MAX_SAFE_INTEGER), e.type = (_a2 = r4.type) == null ? void 0 : _a2.map((t) => ({ ...t, extension: void 0, code: Mn[t.code] ?? t.code })), e;
}
function Bn(r4) {
  let e = r4.max && r4.max === Number.MAX_SAFE_INTEGER ? Number.POSITIVE_INFINITY : r4.max;
  return { path: "", description: "", type: r4.type ?? [], min: r4.min ?? 0, max: e ?? 1, isArray: !!e && e > 1, constraints: [] };
}
function nr(r4) {
  let e = /* @__PURE__ */ Object.create(null);
  for (let [t, n] of Object.entries(r4))
    e[t] = { name: t, elements: Object.fromEntries(Object.entries(n.elements).map(([i, o]) => [i, Bn(o)])), constraints: [], innerTypes: [] };
  return e;
}
var ir = { Element: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] } } }, BackboneElement: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, modifierExtension: { max: 9007199254740991, type: [{ code: "Extension" }] } } }, Address: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, use: { type: [{ code: "code" }] }, type: { type: [{ code: "code" }] }, text: { type: [{ code: "string" }] }, line: { max: 9007199254740991, type: [{ code: "string" }] }, city: { type: [{ code: "string" }] }, district: { type: [{ code: "string" }] }, state: { type: [{ code: "string" }] }, postalCode: { type: [{ code: "string" }] }, country: { type: [{ code: "string" }] }, period: { type: [{ code: "Period" }] } } }, Age: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, value: { type: [{ code: "decimal" }] }, comparator: { type: [{ code: "code" }] }, unit: { type: [{ code: "string" }] }, system: { type: [{ code: "uri" }] }, code: { type: [{ code: "code" }] } } }, Annotation: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, "author[x]": { type: [{ code: "Reference", targetProfile: ["http://hl7.org/fhir/StructureDefinition/Practitioner", "http://hl7.org/fhir/StructureDefinition/Patient", "http://hl7.org/fhir/StructureDefinition/RelatedPerson", "http://hl7.org/fhir/StructureDefinition/Organization"] }, { code: "string" }] }, time: { type: [{ code: "dateTime" }] }, text: { min: 1, type: [{ code: "markdown" }] } } }, Attachment: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, contentType: { type: [{ code: "code" }] }, language: { type: [{ code: "code" }] }, data: { type: [{ code: "base64Binary" }] }, url: { type: [{ code: "url" }] }, size: { type: [{ code: "unsignedInt" }] }, hash: { type: [{ code: "base64Binary" }] }, title: { type: [{ code: "string" }] }, creation: { type: [{ code: "dateTime" }] } } }, CodeableConcept: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, coding: { max: 9007199254740991, type: [{ code: "Coding" }] }, text: { type: [{ code: "string" }] } } }, Coding: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, system: { type: [{ code: "uri" }] }, version: { type: [{ code: "string" }] }, code: { type: [{ code: "code" }] }, display: { type: [{ code: "string" }] }, userSelected: { type: [{ code: "boolean" }] } } }, ContactDetail: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, name: { type: [{ code: "string" }] }, telecom: { max: 9007199254740991, type: [{ code: "ContactPoint" }] } } }, ContactPoint: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, system: { type: [{ code: "code" }] }, value: { type: [{ code: "string" }] }, use: { type: [{ code: "code" }] }, rank: { type: [{ code: "positiveInt" }] }, period: { type: [{ code: "Period" }] } } }, Contributor: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, type: { min: 1, type: [{ code: "code" }] }, name: { min: 1, type: [{ code: "string" }] }, contact: { max: 9007199254740991, type: [{ code: "ContactDetail" }] } } }, Count: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, value: { type: [{ code: "decimal" }] }, comparator: { type: [{ code: "code" }] }, unit: { type: [{ code: "string" }] }, system: { type: [{ code: "uri" }] }, code: { type: [{ code: "code" }] } } }, DataRequirement: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, type: { min: 1, type: [{ code: "code" }] }, profile: { max: 9007199254740991, type: [{ code: "canonical", targetProfile: ["http://hl7.org/fhir/StructureDefinition/StructureDefinition"] }] }, "subject[x]": { type: [{ code: "CodeableConcept" }, { code: "Reference", targetProfile: ["http://hl7.org/fhir/StructureDefinition/Group"] }] }, mustSupport: { max: 9007199254740991, type: [{ code: "string" }] }, codeFilter: { max: 9007199254740991, type: [{ code: "DataRequirementCodeFilter" }] }, dateFilter: { max: 9007199254740991, type: [{ code: "DataRequirementDateFilter" }] }, limit: { type: [{ code: "positiveInt" }] }, sort: { max: 9007199254740991, type: [{ code: "DataRequirementSort" }] } } }, Distance: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, value: { type: [{ code: "decimal" }] }, comparator: { type: [{ code: "code" }] }, unit: { type: [{ code: "string" }] }, system: { type: [{ code: "uri" }] }, code: { type: [{ code: "code" }] } } }, Dosage: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, modifierExtension: { max: 9007199254740991, type: [{ code: "Extension" }] }, sequence: { type: [{ code: "integer" }] }, text: { type: [{ code: "string" }] }, additionalInstruction: { max: 9007199254740991, type: [{ code: "CodeableConcept" }] }, patientInstruction: { type: [{ code: "string" }] }, timing: { type: [{ code: "Timing" }] }, "asNeeded[x]": { type: [{ code: "boolean" }, { code: "CodeableConcept" }] }, site: { type: [{ code: "CodeableConcept" }] }, route: { type: [{ code: "CodeableConcept" }] }, method: { type: [{ code: "CodeableConcept" }] }, doseAndRate: { max: 9007199254740991, type: [{ code: "DosageDoseAndRate" }] }, maxDosePerPeriod: { type: [{ code: "Ratio" }] }, maxDosePerAdministration: { type: [{ code: "Quantity" }] }, maxDosePerLifetime: { type: [{ code: "Quantity" }] } } }, Duration: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, value: { type: [{ code: "decimal" }] }, comparator: { type: [{ code: "code" }] }, unit: { type: [{ code: "string" }] }, system: { type: [{ code: "uri" }] }, code: { type: [{ code: "code" }] } } }, ElementDefinition: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, modifierExtension: { max: 9007199254740991, type: [{ code: "Extension" }] }, path: { min: 1, type: [{ code: "string" }] }, representation: { max: 9007199254740991, type: [{ code: "code" }] }, sliceName: { type: [{ code: "string" }] }, sliceIsConstraining: { type: [{ code: "boolean" }] }, label: { type: [{ code: "string" }] }, code: { max: 9007199254740991, type: [{ code: "Coding" }] }, slicing: { type: [{ code: "ElementDefinitionSlicing" }] }, short: { type: [{ code: "string" }] }, definition: { type: [{ code: "markdown" }] }, comment: { type: [{ code: "markdown" }] }, requirements: { type: [{ code: "markdown" }] }, alias: { max: 9007199254740991, type: [{ code: "string" }] }, min: { type: [{ code: "unsignedInt" }] }, max: { type: [{ code: "string" }] }, base: { type: [{ code: "ElementDefinitionBase" }] }, contentReference: { type: [{ code: "uri" }] }, type: { max: 9007199254740991, type: [{ code: "ElementDefinitionType" }] }, "defaultValue[x]": { type: [{ code: "base64Binary" }, { code: "boolean" }, { code: "canonical" }, { code: "code" }, { code: "date" }, { code: "dateTime" }, { code: "decimal" }, { code: "id" }, { code: "instant" }, { code: "integer" }, { code: "markdown" }, { code: "oid" }, { code: "positiveInt" }, { code: "string" }, { code: "time" }, { code: "unsignedInt" }, { code: "uri" }, { code: "url" }, { code: "uuid" }, { code: "Address" }, { code: "Age" }, { code: "Annotation" }, { code: "Attachment" }, { code: "CodeableConcept" }, { code: "Coding" }, { code: "ContactPoint" }, { code: "Count" }, { code: "Distance" }, { code: "Duration" }, { code: "HumanName" }, { code: "Identifier" }, { code: "Money" }, { code: "Period" }, { code: "Quantity" }, { code: "Range" }, { code: "Ratio" }, { code: "Reference" }, { code: "SampledData" }, { code: "Signature" }, { code: "Timing" }, { code: "ContactDetail" }, { code: "Contributor" }, { code: "DataRequirement" }, { code: "Expression" }, { code: "ParameterDefinition" }, { code: "RelatedArtifact" }, { code: "TriggerDefinition" }, { code: "UsageContext" }, { code: "Dosage" }, { code: "Meta" }] }, meaningWhenMissing: { type: [{ code: "markdown" }] }, orderMeaning: { type: [{ code: "string" }] }, "fixed[x]": { type: [{ code: "base64Binary" }, { code: "boolean" }, { code: "canonical" }, { code: "code" }, { code: "date" }, { code: "dateTime" }, { code: "decimal" }, { code: "id" }, { code: "instant" }, { code: "integer" }, { code: "markdown" }, { code: "oid" }, { code: "positiveInt" }, { code: "string" }, { code: "time" }, { code: "unsignedInt" }, { code: "uri" }, { code: "url" }, { code: "uuid" }, { code: "Address" }, { code: "Age" }, { code: "Annotation" }, { code: "Attachment" }, { code: "CodeableConcept" }, { code: "Coding" }, { code: "ContactPoint" }, { code: "Count" }, { code: "Distance" }, { code: "Duration" }, { code: "HumanName" }, { code: "Identifier" }, { code: "Money" }, { code: "Period" }, { code: "Quantity" }, { code: "Range" }, { code: "Ratio" }, { code: "Reference" }, { code: "SampledData" }, { code: "Signature" }, { code: "Timing" }, { code: "ContactDetail" }, { code: "Contributor" }, { code: "DataRequirement" }, { code: "Expression" }, { code: "ParameterDefinition" }, { code: "RelatedArtifact" }, { code: "TriggerDefinition" }, { code: "UsageContext" }, { code: "Dosage" }, { code: "Meta" }] }, "pattern[x]": { type: [{ code: "base64Binary" }, { code: "boolean" }, { code: "canonical" }, { code: "code" }, { code: "date" }, { code: "dateTime" }, { code: "decimal" }, { code: "id" }, { code: "instant" }, { code: "integer" }, { code: "markdown" }, { code: "oid" }, { code: "positiveInt" }, { code: "string" }, { code: "time" }, { code: "unsignedInt" }, { code: "uri" }, { code: "url" }, { code: "uuid" }, { code: "Address" }, { code: "Age" }, { code: "Annotation" }, { code: "Attachment" }, { code: "CodeableConcept" }, { code: "Coding" }, { code: "ContactPoint" }, { code: "Count" }, { code: "Distance" }, { code: "Duration" }, { code: "HumanName" }, { code: "Identifier" }, { code: "Money" }, { code: "Period" }, { code: "Quantity" }, { code: "Range" }, { code: "Ratio" }, { code: "Reference" }, { code: "SampledData" }, { code: "Signature" }, { code: "Timing" }, { code: "ContactDetail" }, { code: "Contributor" }, { code: "DataRequirement" }, { code: "Expression" }, { code: "ParameterDefinition" }, { code: "RelatedArtifact" }, { code: "TriggerDefinition" }, { code: "UsageContext" }, { code: "Dosage" }, { code: "Meta" }] }, example: { max: 9007199254740991, type: [{ code: "ElementDefinitionExample" }] }, "minValue[x]": { type: [{ code: "date" }, { code: "dateTime" }, { code: "instant" }, { code: "time" }, { code: "decimal" }, { code: "integer" }, { code: "positiveInt" }, { code: "unsignedInt" }, { code: "Quantity" }] }, "maxValue[x]": { type: [{ code: "date" }, { code: "dateTime" }, { code: "instant" }, { code: "time" }, { code: "decimal" }, { code: "integer" }, { code: "positiveInt" }, { code: "unsignedInt" }, { code: "Quantity" }] }, maxLength: { type: [{ code: "integer" }] }, condition: { max: 9007199254740991, type: [{ code: "id" }] }, constraint: { max: 9007199254740991, type: [{ code: "ElementDefinitionConstraint" }] }, mustSupport: { type: [{ code: "boolean" }] }, isModifier: { type: [{ code: "boolean" }] }, isModifierReason: { type: [{ code: "string" }] }, isSummary: { type: [{ code: "boolean" }] }, binding: { type: [{ code: "ElementDefinitionBinding" }] }, mapping: { max: 9007199254740991, type: [{ code: "ElementDefinitionMapping" }] } } }, Expression: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, description: { type: [{ code: "string" }] }, name: { type: [{ code: "id" }] }, language: { min: 1, type: [{ code: "code" }] }, expression: { type: [{ code: "string" }] }, reference: { type: [{ code: "uri" }] } } }, Extension: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, url: { min: 1, type: [{ code: "string" }] }, "value[x]": { type: [{ code: "base64Binary" }, { code: "boolean" }, { code: "canonical" }, { code: "code" }, { code: "date" }, { code: "dateTime" }, { code: "decimal" }, { code: "id" }, { code: "instant" }, { code: "integer" }, { code: "markdown" }, { code: "oid" }, { code: "positiveInt" }, { code: "string" }, { code: "time" }, { code: "unsignedInt" }, { code: "uri" }, { code: "url" }, { code: "uuid" }, { code: "Address" }, { code: "Age" }, { code: "Annotation" }, { code: "Attachment" }, { code: "CodeableConcept" }, { code: "Coding" }, { code: "ContactPoint" }, { code: "Count" }, { code: "Distance" }, { code: "Duration" }, { code: "HumanName" }, { code: "Identifier" }, { code: "Money" }, { code: "Period" }, { code: "Quantity" }, { code: "Range" }, { code: "Ratio" }, { code: "Reference" }, { code: "SampledData" }, { code: "Signature" }, { code: "Timing" }, { code: "ContactDetail" }, { code: "Contributor" }, { code: "DataRequirement" }, { code: "Expression" }, { code: "ParameterDefinition" }, { code: "RelatedArtifact" }, { code: "TriggerDefinition" }, { code: "UsageContext" }, { code: "Dosage" }, { code: "Meta" }] } } }, HumanName: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, use: { type: [{ code: "code" }] }, text: { type: [{ code: "string" }] }, family: { type: [{ code: "string" }] }, given: { max: 9007199254740991, type: [{ code: "string" }] }, prefix: { max: 9007199254740991, type: [{ code: "string" }] }, suffix: { max: 9007199254740991, type: [{ code: "string" }] }, period: { type: [{ code: "Period" }] } } }, Identifier: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, use: { type: [{ code: "code" }] }, type: { type: [{ code: "CodeableConcept" }] }, system: { type: [{ code: "uri" }] }, value: { type: [{ code: "string" }] }, period: { type: [{ code: "Period" }] }, assigner: { type: [{ code: "Reference", targetProfile: ["http://hl7.org/fhir/StructureDefinition/Organization"] }] } } }, MarketingStatus: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, modifierExtension: { max: 9007199254740991, type: [{ code: "Extension" }] }, country: { min: 1, type: [{ code: "CodeableConcept" }] }, jurisdiction: { type: [{ code: "CodeableConcept" }] }, status: { min: 1, type: [{ code: "CodeableConcept" }] }, dateRange: { min: 1, type: [{ code: "Period" }] }, restoreDate: { type: [{ code: "dateTime" }] } } }, Meta: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, versionId: { type: [{ code: "id" }] }, lastUpdated: { type: [{ code: "instant" }] }, source: { type: [{ code: "uri" }] }, profile: { max: 9007199254740991, type: [{ code: "canonical", targetProfile: ["http://hl7.org/fhir/StructureDefinition/StructureDefinition"] }] }, security: { max: 9007199254740991, type: [{ code: "Coding" }] }, tag: { max: 9007199254740991, type: [{ code: "Coding" }] }, project: { type: [{ code: "uri" }] }, author: { type: [{ code: "Reference" }] }, account: { type: [{ code: "Reference" }] }, compartment: { max: 9007199254740991, type: [{ code: "Reference" }] } } }, Money: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, value: { type: [{ code: "decimal" }] }, currency: { type: [{ code: "code" }] } } }, Narrative: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, status: { min: 1, type: [{ code: "code" }] }, div: { min: 1, type: [{ code: "xhtml" }] } } }, ParameterDefinition: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, name: { type: [{ code: "code" }] }, use: { min: 1, type: [{ code: "code" }] }, min: { type: [{ code: "integer" }] }, max: { type: [{ code: "string" }] }, documentation: { type: [{ code: "string" }] }, type: { min: 1, type: [{ code: "code" }] }, profile: { type: [{ code: "canonical", targetProfile: ["http://hl7.org/fhir/StructureDefinition/StructureDefinition"] }] } } }, Period: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, start: { type: [{ code: "dateTime" }] }, end: { type: [{ code: "dateTime" }] } } }, Population: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, modifierExtension: { max: 9007199254740991, type: [{ code: "Extension" }] }, "age[x]": { type: [{ code: "Range" }, { code: "CodeableConcept" }] }, gender: { type: [{ code: "CodeableConcept" }] }, race: { type: [{ code: "CodeableConcept" }] }, physiologicalCondition: { type: [{ code: "CodeableConcept" }] } } }, ProdCharacteristic: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, modifierExtension: { max: 9007199254740991, type: [{ code: "Extension" }] }, height: { type: [{ code: "Quantity" }] }, width: { type: [{ code: "Quantity" }] }, depth: { type: [{ code: "Quantity" }] }, weight: { type: [{ code: "Quantity" }] }, nominalVolume: { type: [{ code: "Quantity" }] }, externalDiameter: { type: [{ code: "Quantity" }] }, shape: { type: [{ code: "string" }] }, color: { max: 9007199254740991, type: [{ code: "string" }] }, imprint: { max: 9007199254740991, type: [{ code: "string" }] }, image: { max: 9007199254740991, type: [{ code: "Attachment" }] }, scoring: { type: [{ code: "CodeableConcept" }] } } }, ProductShelfLife: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, modifierExtension: { max: 9007199254740991, type: [{ code: "Extension" }] }, identifier: { type: [{ code: "Identifier" }] }, type: { min: 1, type: [{ code: "CodeableConcept" }] }, period: { min: 1, type: [{ code: "Quantity" }] }, specialPrecautionsForStorage: { max: 9007199254740991, type: [{ code: "CodeableConcept" }] } } }, Quantity: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, value: { type: [{ code: "decimal" }] }, comparator: { type: [{ code: "code" }] }, unit: { type: [{ code: "string" }] }, system: { type: [{ code: "uri" }] }, code: { type: [{ code: "code" }] } } }, Range: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, low: { type: [{ code: "Quantity" }] }, high: { type: [{ code: "Quantity" }] } } }, Ratio: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, numerator: { type: [{ code: "Quantity" }] }, denominator: { type: [{ code: "Quantity" }] } } }, Reference: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, reference: { type: [{ code: "string" }] }, type: { type: [{ code: "uri" }] }, identifier: { type: [{ code: "Identifier" }] }, display: { type: [{ code: "string" }] } } }, RelatedArtifact: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, type: { min: 1, type: [{ code: "code" }] }, label: { type: [{ code: "string" }] }, display: { type: [{ code: "string" }] }, citation: { type: [{ code: "markdown" }] }, url: { type: [{ code: "url" }] }, document: { type: [{ code: "Attachment" }] }, resource: { type: [{ code: "canonical", targetProfile: ["http://hl7.org/fhir/StructureDefinition/Resource"] }] } } }, SampledData: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, origin: { min: 1, type: [{ code: "Quantity" }] }, period: { min: 1, type: [{ code: "decimal" }] }, factor: { type: [{ code: "decimal" }] }, lowerLimit: { type: [{ code: "decimal" }] }, upperLimit: { type: [{ code: "decimal" }] }, dimensions: { min: 1, type: [{ code: "positiveInt" }] }, data: { type: [{ code: "string" }] } } }, Signature: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, type: { min: 1, max: 9007199254740991, type: [{ code: "Coding" }] }, when: { min: 1, type: [{ code: "instant" }] }, who: { min: 1, type: [{ code: "Reference", targetProfile: ["http://hl7.org/fhir/StructureDefinition/Practitioner", "http://hl7.org/fhir/StructureDefinition/PractitionerRole", "http://hl7.org/fhir/StructureDefinition/RelatedPerson", "http://hl7.org/fhir/StructureDefinition/Patient", "http://hl7.org/fhir/StructureDefinition/Device", "http://hl7.org/fhir/StructureDefinition/Organization"] }] }, onBehalfOf: { type: [{ code: "Reference", targetProfile: ["http://hl7.org/fhir/StructureDefinition/Practitioner", "http://hl7.org/fhir/StructureDefinition/PractitionerRole", "http://hl7.org/fhir/StructureDefinition/RelatedPerson", "http://hl7.org/fhir/StructureDefinition/Patient", "http://hl7.org/fhir/StructureDefinition/Device", "http://hl7.org/fhir/StructureDefinition/Organization"] }] }, targetFormat: { type: [{ code: "code" }] }, sigFormat: { type: [{ code: "code" }] }, data: { type: [{ code: "base64Binary" }] } } }, SubstanceAmount: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, modifierExtension: { max: 9007199254740991, type: [{ code: "Extension" }] }, "amount[x]": { type: [{ code: "Quantity" }, { code: "Range" }, { code: "string" }] }, amountType: { type: [{ code: "CodeableConcept" }] }, amountText: { type: [{ code: "string" }] }, referenceRange: { type: [{ code: "SubstanceAmountReferenceRange" }] } } }, Timing: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, modifierExtension: { max: 9007199254740991, type: [{ code: "Extension" }] }, event: { max: 9007199254740991, type: [{ code: "dateTime" }] }, repeat: { type: [{ code: "TimingRepeat" }] }, code: { type: [{ code: "CodeableConcept" }] } } }, TriggerDefinition: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, type: { min: 1, type: [{ code: "code" }] }, name: { type: [{ code: "string" }] }, "timing[x]": { type: [{ code: "Timing" }, { code: "Reference", targetProfile: ["http://hl7.org/fhir/StructureDefinition/Schedule"] }, { code: "date" }, { code: "dateTime" }] }, data: { max: 9007199254740991, type: [{ code: "DataRequirement" }] }, condition: { type: [{ code: "Expression" }] } } }, UsageContext: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, code: { min: 1, type: [{ code: "Coding" }] }, "value[x]": { min: 1, type: [{ code: "CodeableConcept" }, { code: "Quantity" }, { code: "Range" }, { code: "Reference", targetProfile: ["http://hl7.org/fhir/StructureDefinition/PlanDefinition", "http://hl7.org/fhir/StructureDefinition/ResearchStudy", "http://hl7.org/fhir/StructureDefinition/InsurancePlan", "http://hl7.org/fhir/StructureDefinition/HealthcareService", "http://hl7.org/fhir/StructureDefinition/Group", "http://hl7.org/fhir/StructureDefinition/Location", "http://hl7.org/fhir/StructureDefinition/Organization"] }] } } }, MoneyQuantity: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, value: { type: [{ code: "decimal" }] }, comparator: { type: [{ code: "code" }] }, unit: { type: [{ code: "string" }] }, system: { type: [{ code: "uri" }] }, code: { type: [{ code: "code" }] } } }, SimpleQuantity: { elements: { id: { type: [{ code: "string" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, value: { type: [{ code: "decimal" }] }, comparator: { max: 0, type: [{ code: "code" }] }, unit: { type: [{ code: "string" }] }, system: { type: [{ code: "uri" }] }, code: { type: [{ code: "code" }] } } }, MetadataResource: { elements: { id: { type: [{ code: "string" }] }, meta: { type: [{ code: "Meta" }] }, implicitRules: { type: [{ code: "uri" }] }, language: { type: [{ code: "code" }] }, text: { type: [{ code: "Narrative" }] }, contained: { max: 9007199254740991, type: [{ code: "Resource" }] }, extension: { max: 9007199254740991, type: [{ code: "Extension" }] }, modifierExtension: { max: 9007199254740991, type: [{ code: "Extension" }] }, url: { type: [{ code: "uri" }] }, version: { type: [{ code: "string" }] }, name: { type: [{ code: "string" }] }, title: { type: [{ code: "string" }] }, status: { min: 1, type: [{ code: "code" }] }, experimental: { type: [{ code: "boolean" }] }, date: { type: [{ code: "dateTime" }] }, publisher: { type: [{ code: "string" }] }, contact: { max: 9007199254740991, type: [{ code: "ContactDetail" }] }, description: { type: [{ code: "markdown" }] }, useContext: { max: 9007199254740991, type: [{ code: "UsageContext" }] }, jurisdiction: { max: 9007199254740991, type: [{ code: "CodeableConcept" }] } } }, IdentityProvider: { elements: { authorizeUrl: { min: 1, type: [{ code: "string" }] }, tokenUrl: { min: 1, type: [{ code: "string" }] }, tokenAuthMethod: { type: [{ code: "code" }] }, userInfoUrl: { min: 1, type: [{ code: "string" }] }, clientId: { min: 1, type: [{ code: "string" }] }, clientSecret: { min: 1, type: [{ code: "string" }] }, usePkce: { type: [{ code: "boolean" }] }, useSubject: { type: [{ code: "boolean" }] } } } };
function l(r4) {
  return [{ type: u.boolean, value: r4 }];
}
function T(r4) {
  return r4 == null ? { type: "undefined", value: void 0 } : Number.isSafeInteger(r4) ? { type: u.integer, value: r4 } : typeof r4 == "number" ? { type: u.decimal, value: r4 } : typeof r4 == "boolean" ? { type: u.boolean, value: r4 } : typeof r4 == "string" ? { type: u.string, value: r4 } : b(r4) ? { type: u.Quantity, value: r4 } : N(r4) ? { type: r4.resourceType, value: r4 } : { type: u.BackboneElement, value: r4 };
}
function L(r4) {
  return r4.length === 0 ? false : !!r4[0].value;
}
function D(r4, e) {
  if (r4.length !== 0) {
    if (r4.length === 1 && (!e || r4[0].type === e))
      return r4[0];
    throw new Error(`Expected singleton of type ${e}, but found ${JSON.stringify(r4)}`);
  }
}
function I(r4, e) {
  if (!r4.value)
    return;
  let t = Ce(r4.type, e);
  return t ? $n(r4, e, t) : jn(r4, e);
}
function $n(r4, e, t) {
  let n = t.type;
  if (!n || n.length === 0)
    return;
  let i, o = "undefined";
  if (n.length === 1)
    i = r4.value[e], o = n[0].code;
  else
    for (let a of n) {
      let c = e.replace("[x]", "") + P(a.code);
      if (c in r4.value) {
        i = r4.value[c], o = a.code;
        break;
      }
    }
  let s = r4.value["_" + e];
  if (s && (Array.isArray(i) ? i = i.map((a, c) => s[c] ? cr(a ?? {}, s[c]) : a) : i = cr(i ?? {}, s)), !E(i))
    return (o === "Element" || o === "BackboneElement") && (o = t.type[0].code), Array.isArray(i) ? i.map((a) => or(a, o)) : or(i, o);
}
function or(r4, e) {
  return e === "Resource" && N(r4) && (e = r4.resourceType), { type: e, value: r4 };
}
function jn(r4, e) {
  let t = r4.value;
  if (!t || typeof t != "object")
    return;
  let n;
  if (e in t)
    n = t[e];
  else
    for (let i in u) {
      let o = e + P(i);
      if (o in t) {
        n = t[o];
        break;
      }
    }
  if (!E(n))
    return Array.isArray(n) ? n.map(T) : T(n);
}
function Pe(r4) {
  let e = [];
  for (let t of r4) {
    let n = false;
    for (let i of e)
      if (L(ur(t, i))) {
        n = true;
        break;
      }
    n || e.push(t);
  }
  return e;
}
function ct(r4) {
  return l(!L(r4));
}
function ut(r4, e) {
  return r4.length === 0 || e.length === 0 ? [] : r4.length !== e.length ? l(false) : l(r4.every((t, n) => L(ur(t, e[n]))));
}
function ur(r4, e) {
  var _a2, _b;
  let t = (_a2 = r4.value) == null ? void 0 : _a2.valueOf(), n = (_b = e.value) == null ? void 0 : _b.valueOf();
  return typeof t == "number" && typeof n == "number" ? l(Math.abs(t - n) < 1e-8) : b(t) && b(n) ? l(lr(t, n)) : l(typeof t == "object" && typeof n == "object" ? dt(r4, e) : t === n);
}
function lt(r4, e) {
  return r4.length === 0 && e.length === 0 ? l(true) : r4.length !== e.length ? l(false) : (r4.sort(sr), e.sort(sr), l(r4.every((t, n) => L(Qn(t, e[n])))));
}
function Qn(r4, e) {
  let { type: t, value: n } = r4, { type: i, value: o } = e, s = n == null ? void 0 : n.valueOf(), a = o == null ? void 0 : o.valueOf();
  return typeof s == "number" && typeof a == "number" ? l(Math.abs(s - a) < 0.01) : b(s) && b(a) ? l(lr(s, a)) : l(t === "Coding" && i === "Coding" ? typeof s != "object" || typeof a != "object" ? false : s.code === a.code && s.system === a.system : typeof s == "object" && typeof a == "object" ? dt({ ...s, id: void 0 }, { ...a, id: void 0 }) : typeof s == "string" && typeof a == "string" ? s.toLowerCase() === a.toLowerCase() : s === a);
}
function sr(r4, e) {
  var _a2, _b;
  let t = (_a2 = r4.value) == null ? void 0 : _a2.valueOf(), n = (_b = e.value) == null ? void 0 : _b.valueOf();
  return typeof t == "number" && typeof n == "number" ? t - n : typeof t == "string" && typeof n == "string" ? t.localeCompare(n) : 0;
}
function Ae(r4, e) {
  let { value: t } = r4;
  if (t == null)
    return false;
  switch (e) {
    case "Boolean":
      return typeof t == "boolean";
    case "Decimal":
    case "Integer":
      return typeof t == "number";
    case "Date":
      return typeof t == "string" && !!/^\d{4}(-\d{2}(-\d{2})?)?/.exec(t);
    case "DateTime":
      return typeof t == "string" && !!/^\d{4}(-\d{2}(-\d{2})?)?T/.exec(t);
    case "Time":
      return typeof t == "string" && !!/^T\d/.exec(t);
    case "Period":
      return Hn(t);
    case "Quantity":
      return b(t);
    default:
      return typeof t == "object" && (t == null ? void 0 : t.resourceType) === e;
  }
}
function Hn(r4) {
  return !!(r4 && typeof r4 == "object" && "start" in r4);
}
function b(r4) {
  return !!(r4 && typeof r4 == "object" && "value" in r4 && typeof r4.value == "number");
}
function lr(r4, e) {
  return Math.abs(r4.value - e.value) < 0.01 && (r4.unit === e.unit || r4.code === e.code || r4.unit === e.code || r4.code === e.unit);
}
function dt(r4, e) {
  let t = Object.keys(r4), n = Object.keys(e);
  if (t.length !== n.length)
    return false;
  for (let i of t) {
    let o = r4[i], s = e[i];
    if (ar(o) && ar(s)) {
      if (!dt(o, s))
        return false;
    } else if (o !== s)
      return false;
  }
  return true;
}
function ar(r4) {
  return r4 !== null && typeof r4 == "object";
}
function cr(r4, e) {
  return delete e.__proto__, delete e.constructor, Object.assign(r4, e);
}
var pt = "ok";
var we = "created";
var ft = "gone";
var mt = "not-modified";
var ht = "not-found";
var dr = "unauthorized";
var pr = "forbidden";
var fr = "too-many-requests";
var Ie = "accepted";
var ps = { resourceType: "OperationOutcome", id: pt, issue: [{ severity: "information", code: "informational", details: { text: "All OK" } }] };
var fs = { resourceType: "OperationOutcome", id: we, issue: [{ severity: "information", code: "informational", details: { text: "Created" } }] };
var ms = { resourceType: "OperationOutcome", id: mt, issue: [{ severity: "information", code: "informational", details: { text: "Not Modified" } }] };
var mr = { resourceType: "OperationOutcome", id: ht, issue: [{ severity: "error", code: "not-found", details: { text: "Not found" } }] };
var hs = { resourceType: "OperationOutcome", id: dr, issue: [{ severity: "error", code: "login", details: { text: "Unauthorized" } }] };
var ys = { resourceType: "OperationOutcome", id: pr, issue: [{ severity: "error", code: "forbidden", details: { text: "Forbidden" } }] };
var gs = { resourceType: "OperationOutcome", id: ft, issue: [{ severity: "error", code: "deleted", details: { text: "Gone" } }] };
var xs = { resourceType: "OperationOutcome", id: fr, issue: [{ severity: "error", code: "throttled", details: { text: "Too Many Requests" } }] };
function Ts(r4) {
  return { resourceType: "OperationOutcome", id: Ie, issue: [{ severity: "information", code: "informational", details: { text: "Accepted" }, diagnostics: r4 }] };
}
function F(r4, e) {
  return { resourceType: "OperationOutcome", issue: [{ severity: "error", code: "invalid", details: { text: r4 }, expression: e ? [e] : void 0 }] };
}
function h(r4) {
  return { resourceType: "OperationOutcome", issue: [{ severity: "error", code: "structure", details: { text: r4 } }] };
}
function hr(r4) {
  return { resourceType: "OperationOutcome", issue: [{ severity: "error", code: "exception", details: { text: "Internal server error" }, diagnostics: r4.toString() }] };
}
function ke(r4) {
  return typeof r4 == "object" && r4 !== null && r4.resourceType === "OperationOutcome";
}
function yt(r4) {
  return r4.id === pt || r4.id === we || r4.id === mt || r4.id === Ie;
}
function vs(r4) {
  return r4.id === we;
}
function Ss(r4) {
  return r4.id === Ie;
}
function Es(r4) {
  return r4.id === ht;
}
function bs(r4) {
  return r4.id === ft;
}
function Rs(r4) {
  return r4.id === pt ? 200 : r4.id === we ? 201 : r4.id === Ie ? 202 : r4.id === mt ? 304 : r4.id === dr ? 401 : r4.id === pr ? 403 : r4.id === ht ? 404 : r4.id === ft ? 410 : r4.id === fr ? 429 : 400;
}
function Ps(r4, e) {
  if (!yt(r4) || e === void 0)
    throw new d(r4);
}
var d = class extends Error {
  constructor(t, n) {
    super(yr(t));
    this.outcome = t, this.cause = n;
  }
};
function Oe(r4) {
  return r4 instanceof d ? r4.outcome : ke(r4) ? r4 : F(Kn(r4));
}
function Kn(r4) {
  return r4 ? typeof r4 == "string" ? r4 : r4 instanceof Error ? r4.message : ke(r4) ? yr(r4) : typeof r4 == "object" && "code" in r4 && typeof r4.code == "string" ? r4.code : JSON.stringify(r4) : "Unknown error";
}
function yr(r4) {
  var _a2;
  let e = ((_a2 = r4.issue) == null ? void 0 : _a2.map(Wn)) ?? [];
  return e.length > 0 ? e.join("; ") : "Unknown error";
}
function Wn(r4) {
  var _a2, _b;
  let e;
  return ((_a2 = r4.details) == null ? void 0 : _a2.text) ? r4.diagnostics ? e = `${r4.details.text} (${r4.diagnostics})` : e = r4.details.text : r4.diagnostics ? e = r4.diagnostics : e = "Unknown error", ((_b = r4.expression) == null ? void 0 : _b.length) && (e += ` (${r4.expression.join(", ")})`), e;
}
function gt(r4, e, t, n) {
  let i = { severity: "error", code: r4, details: { text: e }, expression: [t] };
  return n && (i.diagnostics = JSON.stringify(n)), i;
}
function y(r4, e) {
  return gt("structure", e, r4);
}
function gr(r4, e) {
  return gt("invariant", `Constraint ${e.key} not met: ${e.description}`, r4, { fhirpath: e.expression });
}
function xr(r4, e, t, n) {
  return gt("processing", e, r4, { ...n, error: t });
}
function St(r4) {
  return new Tt(r4).parse();
}
var Q = nr(ir);
function Er(r4) {
  var _a2;
  let e = Array.isArray(r4) ? r4 : ((_a2 = r4.entry) == null ? void 0 : _a2.map((t) => t.resource)) ?? [];
  for (let t of e)
    Gn(t);
}
function Gn(r4) {
  if (!(r4 == null ? void 0 : r4.name))
    throw new Error("Failed loading StructureDefinition from bundle");
  if (r4.resourceType !== "StructureDefinition")
    return;
  let e = St(r4);
  Q[r4.name] = e;
  for (let t of e.innerTypes)
    t.parentType = e, Q[t.name] = t;
}
function br() {
  return Q;
}
function Rr(r4) {
  return !!Q[r4];
}
function Pr(r4) {
  return Q[r4];
}
function te(r4) {
  let e = Q[r4];
  if (!e)
    throw new d(hr(Error("Unknown data type: " + r4)));
  return e;
}
function Ar(r4) {
  let e = Q[r4];
  return e && Et(e);
}
var Tt = class {
  constructor(e) {
    var _a2;
    if (!((_a2 = e.snapshot) == null ? void 0 : _a2.element) || e.snapshot.element.length === 0)
      throw new Error(`No snapshot defined for StructureDefinition '${e.name}'`);
    this.root = e.snapshot.element[0], this.elements = e.snapshot.element.slice(1), this.elementIndex = /* @__PURE__ */ Object.create(null), this.index = 0, this.resourceSchema = { name: e.name, url: e.url, kind: e.kind, description: Xn(e), elements: {}, constraints: this.parseElementDefinition(this.root).constraints, innerTypes: [], summaryProperties: /* @__PURE__ */ new Set(), mandatoryProperties: /* @__PURE__ */ new Set() }, this.innerTypes = [];
  }
  parse() {
    var _a2, _b, _c, _d, _e2;
    let e = this.next();
    for (; e; ) {
      if (e.sliceName)
        this.parseSliceStart(e);
      else if ((_a2 = e.id) == null ? void 0 : _a2.includes(":")) {
        if ((_b = this.slicingContext) == null ? void 0 : _b.current) {
          let t = xt(e, this.slicingContext.path);
          this.slicingContext.current.elements[t] = this.parseElementDefinition(e);
        }
      } else {
        let t = this.parseElementDefinition(e);
        this.checkFieldEnter(e, t);
        let n = this.backboneContext;
        for (; n; ) {
          if ((_c = e.path) == null ? void 0 : _c.startsWith(n.path + ".")) {
            n.type.elements[xt(e, n.path)] = t;
            break;
          }
          n = n.parent;
        }
        if (!n) {
          let i = xt(e, this.root.path);
          e.isSummary && ((_d = this.resourceSchema.summaryProperties) == null ? void 0 : _d.add(i.replace("[x]", ""))), t.min > 0 && ((_e2 = this.resourceSchema.mandatoryProperties) == null ? void 0 : _e2.add(i.replace("[x]", ""))), this.resourceSchema.elements[i] = t;
        }
        this.checkFieldExit(e);
      }
      e = this.next();
    }
    return this.checkFieldExit(), this.innerTypes.length > 0 && (this.resourceSchema.innerTypes = this.innerTypes), this.resourceSchema;
  }
  checkFieldEnter(e, t) {
    this.isInnerType(e) && this.enterInnerType(e), e.slicing && !this.slicingContext && this.enterSlice(e, t);
  }
  enterInnerType(e) {
    var _a2, _b, _c;
    for (; this.backboneContext && !ee((_a2 = this.backboneContext) == null ? void 0 : _a2.path, e.path); )
      this.innerTypes.push(this.backboneContext.type), this.backboneContext = this.backboneContext.parent;
    this.backboneContext = { type: { name: vt(e), description: e.definition, elements: {}, constraints: this.parseElementDefinition(e).constraints, innerTypes: [] }, path: e.path ?? "", parent: ee((_b = this.backboneContext) == null ? void 0 : _b.path, e.path) ? this.backboneContext : (_c = this.backboneContext) == null ? void 0 : _c.parent };
  }
  enterSlice(e, t) {
    var _a2, _b, _c, _d;
    Yn(e) && !((_a2 = this.peek()) == null ? void 0 : _a2.sliceName) || (t.slicing = { discriminator: (((_b = e.slicing) == null ? void 0 : _b.discriminator) ?? []).map((n) => {
      if (n.type !== "value" && n.type !== "pattern" && n.type !== "type")
        throw new Error(`Unsupported slicing discriminator type: ${n.type}`);
      return { path: n.path, type: n.type };
    }), slices: [], ordered: ((_c = e.slicing) == null ? void 0 : _c.ordered) ?? false, rule: (_d = e.slicing) == null ? void 0 : _d.rules }, this.slicingContext = { field: t.slicing, path: e.path ?? "" });
  }
  checkFieldExit(e = void 0) {
    var _a2;
    if (this.backboneContext && !ee(this.backboneContext.path, e == null ? void 0 : e.path))
      if (this.backboneContext.parent)
        do
          this.innerTypes.push(this.backboneContext.type), this.backboneContext = this.backboneContext.parent;
        while (this.backboneContext && !ee(this.backboneContext.path, e == null ? void 0 : e.path));
      else
        this.innerTypes.push(this.backboneContext.type), delete this.backboneContext;
    this.slicingContext && !ee(this.slicingContext.path, e == null ? void 0 : e.path) && (((_a2 = this.slicingContext) == null ? void 0 : _a2.current) && this.slicingContext.field.slices.push(this.slicingContext.current), delete this.slicingContext);
  }
  next() {
    let e = this.peek();
    if (e)
      return this.index++, e;
  }
  peek() {
    let e = this.elements[this.index];
    if (e) {
      if (this.elementIndex[e.path ?? ""] = e, e.contentReference) {
        let t = this.elementIndex[e.contentReference.slice(e.contentReference.indexOf("#") + 1)];
        return t ? { ...t, id: e.id, path: e.path, min: e.min ?? t.min, max: e.max ?? t.max, contentReference: e.contentReference, definition: e.definition } : void 0;
      }
      return e;
    }
  }
  isInnerType(e) {
    var _a2;
    let t = this.peek();
    return !!(ee(e == null ? void 0 : e.path, t == null ? void 0 : t.path) && ((_a2 = e.type) == null ? void 0 : _a2.some((n) => ["BackboneElement", "Element"].includes(n.code))));
  }
  parseSliceStart(e) {
    var _a2;
    if (!this.slicingContext)
      throw new Error("Invalid slice start before discriminator: " + e.sliceName);
    this.slicingContext.current && this.slicingContext.field.slices.push(this.slicingContext.current), this.slicingContext.current = { name: e.sliceName ?? "", type: (_a2 = e.type) == null ? void 0 : _a2.map((t) => ({ code: t.code ?? "", targetProfile: t.targetProfile })), elements: {}, min: e.min ?? 0, max: e.max === "*" ? Number.POSITIVE_INFINITY : Number.parseInt(e.max, 10) };
  }
  parseElementDefinition(e) {
    var _a2, _b;
    let t = vr(e.max), n = ((_a2 = e.base) == null ? void 0 : _a2.max) ? vr(e.base.max) : t, i = { type: "ElementDefinition", value: e };
    return { description: e.definition || "", path: e.path || ((_b = e.base) == null ? void 0 : _b.path) || "", min: e.min ?? 0, max: t, isArray: n > 1, constraints: (e.constraint ?? []).map((o) => ({ key: o.key ?? "", severity: o.severity ?? "error", expression: o.expression ?? "", description: o.human ?? "" })), type: (e.type ?? []).map((o) => ({ code: ["BackboneElement", "Element"].includes(o.code) ? vt(e) : o.code ?? "", targetProfile: o.targetProfile })), fixed: Sr(I(i, "fixed")), pattern: Sr(I(i, "pattern")), binding: e.binding };
  }
};
function Ns(r4, e) {
  var _a2;
  if (!r4)
    return;
  let t = [];
  for (let n of e) {
    t.push("_" + n);
    let i = Q[r4.resourceType].elements[n + "[x]"];
    i && t.push(...i.type.map((o) => n + P(o.code)));
  }
  for (let n of Object.getOwnPropertyNames(r4))
    !e.includes(n) && !t.includes(n) && !zn.includes(n) && Object.defineProperty(r4, n, { enumerable: false, writable: false, value: void 0 });
  return r4.meta = { ...r4.meta, tag: ((_a2 = r4.meta) == null ? void 0 : _a2.tag) ? r4.meta.tag.concat(Tr) : [Tr] }, r4;
}
var Tr = { system: "http://hl7.org/fhir/v3/ObservationValue", code: "SUBSETTED" };
var zn = ["resourceType", "id", "meta"];
function vr(r4) {
  return r4 === "*" ? Number.POSITIVE_INFINITY : Number.parseInt(r4, 10);
}
function xt(r4, e = "") {
  return Jn(r4.path, e);
}
function Jn(r4, e) {
  return r4 ? e && r4.startsWith(e) ? r4.substring(e.length + 1) : r4 : "";
}
function ee(r4, e) {
  return !r4 || !e ? false : e.startsWith(r4 + ".") || e === r4;
}
function Sr(r4) {
  return Array.isArray(r4) && r4.length > 0 ? r4[0] : E(r4) ? void 0 : r4;
}
function Yn(r4) {
  var _a2, _b;
  let e = (_a2 = r4.slicing) == null ? void 0 : _a2.discriminator;
  return !!(((_b = r4.type) == null ? void 0 : _b.some((t) => t.code === "Extension")) && (e == null ? void 0 : e.length) === 1 && e[0].type === "value" && e[0].path === "url");
}
function Xn(r4) {
  let e = r4.description;
  return (e == null ? void 0 : e.startsWith(`Base StructureDefinition for ${r4.name} Type: `)) && (e = e.substring(`Base StructureDefinition for ${r4.name} Type: `.length)), e;
}
var u = { Address: "Address", Age: "Age", Annotation: "Annotation", Attachment: "Attachment", BackboneElement: "BackboneElement", CodeableConcept: "CodeableConcept", Coding: "Coding", ContactDetail: "ContactDetail", ContactPoint: "ContactPoint", Contributor: "Contributor", Count: "Count", DataRequirement: "DataRequirement", Distance: "Distance", Dosage: "Dosage", Duration: "Duration", Expression: "Expression", Extension: "Extension", HumanName: "HumanName", Identifier: "Identifier", MarketingStatus: "MarketingStatus", Meta: "Meta", Money: "Money", Narrative: "Narrative", ParameterDefinition: "ParameterDefinition", Period: "Period", Population: "Population", ProdCharacteristic: "ProdCharacteristic", ProductShelfLife: "ProductShelfLife", Quantity: "Quantity", Range: "Range", Ratio: "Ratio", Reference: "Reference", RelatedArtifact: "RelatedArtifact", SampledData: "SampledData", Signature: "Signature", SubstanceAmount: "SubstanceAmount", SystemString: "http://hl7.org/fhirpath/System.String", Timing: "Timing", TriggerDefinition: "TriggerDefinition", UsageContext: "UsageContext", base64Binary: "base64Binary", boolean: "boolean", canonical: "canonical", code: "code", date: "date", dateTime: "dateTime", decimal: "decimal", id: "id", instant: "instant", integer: "integer", markdown: "markdown", oid: "oid", positiveInt: "positiveInt", string: "string", time: "time", unsignedInt: "unsignedInt", uri: "uri", url: "url", uuid: "uuid" };
function qs(r4) {
  for (let e of r4.entry) {
    let t = e.resource;
    t.resourceType === "SearchParameter" && bt(t);
  }
}
function bt(r4) {
  for (let e of r4.base ?? []) {
    let t = k.types[e];
    t || (t = { searchParamsDetails: {} }, k.types[e] = t), t.searchParams || (t.searchParams = { _id: { base: [e], code: "_id", type: "token", expression: e + ".id" }, _lastUpdated: { base: [e], code: "_lastUpdated", type: "date", expression: e + ".meta.lastUpdated" }, _compartment: { base: [e], code: "_compartment", type: "reference", expression: e + ".meta.compartment" }, _profile: { base: [e], code: "_profile", type: "uri", expression: e + ".meta.profile" }, _security: { base: [e], code: "_security", type: "token", expression: e + ".meta.security" }, _source: { base: [e], code: "_source", type: "uri", expression: e + ".meta.source" }, _tag: { base: [e], code: "_tag", type: "token", expression: e + ".meta.tag" } }), t.searchParams[r4.code] = r4;
  }
}
function vt(r4) {
  var _a2, _b, _c, _d;
  let e = (_b = (_a2 = r4.type) == null ? void 0 : _a2[0]) == null ? void 0 : _b.code;
  return e === "BackboneElement" || e === "Element" ? Zn((_d = ((_c = r4.base) == null ? void 0 : _c.path) ?? r4.path) == null ? void 0 : _d.split(".")) : e;
}
function Zn(r4) {
  return r4.length === 1 ? r4[0] : r4.map(P).join("");
}
function Et(r4) {
  return r4.kind === "resource" && r4.name !== "Resource" && r4.name !== "DomainResource";
}
function $s() {
  return Object.values(br()).filter(Et).map((r4) => r4.name);
}
function js(r4) {
  var _a2;
  return (_a2 = k.types[r4]) == null ? void 0 : _a2.searchParams;
}
function Qs(r4, e) {
  var _a2, _b;
  return (_b = (_a2 = k.types[r4]) == null ? void 0 : _a2.searchParams) == null ? void 0 : _b[e];
}
function Hs(r4) {
  return r4.replaceAll("[x]", "").split(".").pop().split(/(?=[A-Z])/).map(ti).join(" ").replace("_", " ").replace(/\s+/g, " ");
}
var ei = /* @__PURE__ */ new Set(["ID", "IP", "PKCE", "JWKS", "URI", "URL"]);
function ti(r4) {
  let e = r4.toUpperCase();
  return ei.has(e) ? e : e.charAt(0) + r4.slice(1);
}
function Ce(r4, e) {
  let t = Pr(r4);
  if (t)
    return t.elements[e] ?? t.elements[e + "[x]"];
}
function N(r4) {
  return !!(r4 && typeof r4 == "object" && "resourceType" in r4);
}
function ae(r4) {
  return !!(r4 && typeof r4 == "object" && "reference" in r4);
}
var k = { types: {} };
function wr(r4) {
  var _a2;
  switch (r4.type) {
    case u.uuid:
    case u.uri:
    case u.url:
    case u.string:
    case u.oid:
    case u.markdown:
    case u.id:
    case u.code:
    case u.canonical:
    case u.base64Binary:
    case u.SystemString:
    case u.date:
    case u.dateTime:
    case u.instant:
      return r4.value;
    case u.Identifier:
      return `${r4.value.system ?? ""}|${r4.value.value}`;
    case u.Coding:
      return Cr(r4.value);
    case u.CodeableConcept:
      return ((_a2 = r4.value.coding) == null ? void 0 : _a2.map(Cr).join(",")) ?? r4.value.text;
    case u.HumanName:
      return r4.value.text ? r4.value.text : Re(r4.value);
    case u.unsignedInt:
    case u.positiveInt:
    case u.integer:
    case u.decimal:
      return r4.value.toString();
    case u.boolean:
      return r4.value ? "true" : "false";
    case u.Extension:
      return r4.value.url;
    case u.ContactPoint:
      return r4.value.value;
    case u.Quantity:
    case u.Age:
    case u.Count:
    case u.Duration:
      return `${r4.value.value}|${r4.value.system ?? ""}|${r4.value.code ?? r4.value.unit ?? ""}`;
    case u.Reference:
      return r4.value.reference;
    default:
      return N(r4.value) ? G(r4.value).reference : JSON.stringify(r4);
  }
}
function Cr(r4) {
  return r4 ? `${r4.system ?? ""}|${r4.code}` : "";
}
function re(r4) {
  if (r4.startsWith("T"))
    return r4 + "T00:00:00.000Z".substring(r4.length);
  if (r4.length <= 10)
    return r4;
  try {
    return new Date(r4).toISOString();
  } catch {
    return r4;
  }
}
var ce = () => [];
var S = { empty: (r4, e) => l(e.length === 0), exists: (r4, e, t) => t ? l(e.filter((n) => L(t.eval(r4, [n]))).length > 0) : l(e.length > 0), all: (r4, e, t) => l(e.every((n) => L(t.eval(r4, [n])))), allTrue: (r4, e) => {
  for (let t of e)
    if (!t.value)
      return l(false);
  return l(true);
}, anyTrue: (r4, e) => {
  for (let t of e)
    if (t.value)
      return l(true);
  return l(false);
}, allFalse: (r4, e) => {
  for (let t of e)
    if (t.value)
      return l(false);
  return l(true);
}, anyFalse: (r4, e) => {
  for (let t of e)
    if (!t.value)
      return l(true);
  return l(false);
}, subsetOf: ce, supersetOf: ce, count: (r4, e) => [{ type: u.integer, value: e.length }], distinct: (r4, e) => {
  let t = [];
  for (let n of e)
    t.some((i) => i.value === n.value) || t.push(n);
  return t;
}, isDistinct: (r4, e) => l(e.length === S.distinct(r4, e).length), where: (r4, e, t) => e.filter((n) => L(t.eval(r4, [n]))), select: (r4, e, t) => e.map((n) => t.eval(r4, [n])).flat(), repeat: ce, ofType: (r4, e, t) => e.filter((n) => n.type === t.name), single: (r4, e) => {
  if (e.length > 1)
    throw new Error("Expected input length one for single()");
  return e.length === 0 ? [] : e.slice(0, 1);
}, first: (r4, e) => e.length === 0 ? [] : e.slice(0, 1), last: (r4, e) => e.length === 0 ? [] : e.slice(e.length - 1, e.length), tail: (r4, e) => e.length === 0 ? [] : e.slice(1, e.length), skip: (r4, e, t) => {
  var _a2;
  let n = (_a2 = t.eval(r4, e)[0]) == null ? void 0 : _a2.value;
  if (typeof n != "number")
    throw new Error("Expected a number for skip(num)");
  return n >= e.length ? [] : n <= 0 ? e : e.slice(n, e.length);
}, take: (r4, e, t) => {
  var _a2;
  let n = (_a2 = t.eval(r4, e)[0]) == null ? void 0 : _a2.value;
  if (typeof n != "number")
    throw new Error("Expected a number for take(num)");
  return n >= e.length ? e : n <= 0 ? [] : e.slice(0, n);
}, intersect: (r4, e, t) => {
  if (!t)
    return e;
  let n = t.eval(r4, e), i = [];
  for (let o of e)
    !i.some((s) => s.value === o.value) && n.some((s) => s.value === o.value) && i.push(o);
  return i;
}, exclude: (r4, e, t) => {
  if (!t)
    return e;
  let n = t.eval(r4, e), i = [];
  for (let o of e)
    n.some((s) => s.value === o.value) || i.push(o);
  return i;
}, union: (r4, e, t) => {
  if (!t)
    return e;
  let n = t.eval(r4, e);
  return Pe([...e, ...n]);
}, combine: (r4, e, t) => {
  if (!t)
    return e;
  let n = t.eval(r4, e);
  return [...e, ...n];
}, htmlChecks: (r4, e, t) => [T(true)], iif: (r4, e, t, n, i) => {
  let o = t.eval(r4, e);
  if (o.length > 1 || o.length === 1 && typeof o[0].value != "boolean")
    throw new Error("Expected criterion to evaluate to a Boolean");
  return L(o) ? n.eval(r4, e) : i ? i.eval(r4, e) : [];
}, toBoolean: (r4, e) => {
  if (e.length === 0)
    return [];
  let [{ value: t }] = U(e, 1);
  if (typeof t == "boolean")
    return [{ type: u.boolean, value: t }];
  if (typeof t == "number" && (t === 0 || t === 1))
    return l(!!t);
  if (typeof t == "string") {
    let n = t.toLowerCase();
    if (["true", "t", "yes", "y", "1", "1.0"].includes(n))
      return l(true);
    if (["false", "f", "no", "n", "0", "0.0"].includes(n))
      return l(false);
  }
  return [];
}, convertsToBoolean: (r4, e) => e.length === 0 ? [] : l(S.toBoolean(r4, e).length === 1), toInteger: (r4, e) => {
  if (e.length === 0)
    return [];
  let [{ value: t }] = U(e, 1);
  return typeof t == "number" ? [{ type: u.integer, value: t }] : typeof t == "string" && /^[+-]?\d+$/.exec(t) ? [{ type: u.integer, value: parseInt(t, 10) }] : typeof t == "boolean" ? [{ type: u.integer, value: t ? 1 : 0 }] : [];
}, convertsToInteger: (r4, e) => e.length === 0 ? [] : l(S.toInteger(r4, e).length === 1), toDate: (r4, e) => {
  if (e.length === 0)
    return [];
  let [{ value: t }] = U(e, 1);
  return typeof t == "string" && /^\d{4}(-\d{2}(-\d{2})?)?/.exec(t) ? [{ type: u.date, value: re(t) }] : [];
}, convertsToDate: (r4, e) => e.length === 0 ? [] : l(S.toDate(r4, e).length === 1), toDateTime: (r4, e) => {
  if (e.length === 0)
    return [];
  let [{ value: t }] = U(e, 1);
  return typeof t == "string" && /^\d{4}(-\d{2}(-\d{2})?)?/.exec(t) ? [{ type: u.dateTime, value: re(t) }] : [];
}, convertsToDateTime: (r4, e) => e.length === 0 ? [] : l(S.toDateTime(r4, e).length === 1), toDecimal: (r4, e) => {
  if (e.length === 0)
    return [];
  let [{ value: t }] = U(e, 1);
  return typeof t == "number" ? [{ type: u.decimal, value: t }] : typeof t == "string" && /^-?\d{1,9}(\.\d{1,9})?$/.exec(t) ? [{ type: u.decimal, value: parseFloat(t) }] : typeof t == "boolean" ? [{ type: u.decimal, value: t ? 1 : 0 }] : [];
}, convertsToDecimal: (r4, e) => e.length === 0 ? [] : l(S.toDecimal(r4, e).length === 1), toQuantity: (r4, e) => {
  if (e.length === 0)
    return [];
  let [{ value: t }] = U(e, 1);
  return b(t) ? [{ type: u.Quantity, value: t }] : typeof t == "number" ? [{ type: u.Quantity, value: { value: t, unit: "1" } }] : typeof t == "string" && /^-?\d{1,9}(\.\d{1,9})?/.exec(t) ? [{ type: u.Quantity, value: { value: parseFloat(t), unit: "1" } }] : typeof t == "boolean" ? [{ type: u.Quantity, value: { value: t ? 1 : 0, unit: "1" } }] : [];
}, convertsToQuantity: (r4, e) => e.length === 0 ? [] : l(S.toQuantity(r4, e).length === 1), toString: (r4, e) => {
  if (e.length === 0)
    return [];
  let [{ value: t }] = U(e, 1);
  return t == null ? [] : b(t) ? [{ type: u.string, value: `${t.value} '${t.unit}'` }] : [{ type: u.string, value: t.toString() }];
}, convertsToString: (r4, e) => e.length === 0 ? [] : l(S.toString(r4, e).length === 1), toTime: (r4, e) => {
  if (e.length === 0)
    return [];
  let [{ value: t }] = U(e, 1);
  if (typeof t == "string") {
    let n = /^T?(\d{2}(:\d{2}(:\d{2})?)?)/.exec(t);
    if (n)
      return [{ type: u.time, value: re("T" + n[1]) }];
  }
  return [];
}, convertsToTime: (r4, e) => e.length === 0 ? [] : l(S.toTime(r4, e).length === 1), indexOf: (r4, e, t) => A((n, i) => n.indexOf(i), r4, e, t), substring: (r4, e, t, n) => A((i, o, s) => {
  let a = o, c = s ? a + s : i.length;
  return a < 0 || a >= i.length ? void 0 : i.substring(a, c);
}, r4, e, t, n), startsWith: (r4, e, t) => A((n, i) => n.startsWith(i), r4, e, t), endsWith: (r4, e, t) => A((n, i) => n.endsWith(i), r4, e, t), contains: (r4, e, t) => A((n, i) => n.includes(i), r4, e, t), upper: (r4, e) => A((t) => t.toUpperCase(), r4, e), lower: (r4, e) => A((t) => t.toLowerCase(), r4, e), replace: (r4, e, t, n) => A((i, o, s) => i.replaceAll(o, s), r4, e, t, n), matches: (r4, e, t) => A((n, i) => !!new RegExp(i).exec(n), r4, e, t), replaceMatches: (r4, e, t, n) => A((i, o, s) => i.replaceAll(o, s), r4, e, t, n), length: (r4, e) => A((t) => t.length, r4, e), toChars: (r4, e) => A((t) => t ? t.split("") : void 0, r4, e), abs: (r4, e) => _(Math.abs, r4, e), ceiling: (r4, e) => _(Math.ceil, r4, e), exp: (r4, e) => _(Math.exp, r4, e), floor: (r4, e) => _(Math.floor, r4, e), ln: (r4, e) => _(Math.log, r4, e), log: (r4, e, t) => _((n, i) => Math.log(n) / Math.log(i), r4, e, t), power: (r4, e, t) => _(Math.pow, r4, e, t), round: (r4, e) => _(Math.round, r4, e), sqrt: (r4, e) => _(Math.sqrt, r4, e), truncate: (r4, e) => _((t) => t | 0, r4, e), children: ce, descendants: ce, trace: (r4, e, t) => (console.log("trace", e, t), e), now: () => [{ type: u.dateTime, value: (/* @__PURE__ */ new Date()).toISOString() }], timeOfDay: () => [{ type: u.time, value: (/* @__PURE__ */ new Date()).toISOString().substring(11) }], today: () => [{ type: u.date, value: (/* @__PURE__ */ new Date()).toISOString().substring(0, 10) }], between: (r4, e, t, n, i) => {
  var _a2;
  let o = S.toDateTime(r4, t.eval(r4, e));
  if (o.length === 0)
    throw new Error("Invalid start date");
  let s = S.toDateTime(r4, n.eval(r4, e));
  if (s.length === 0)
    throw new Error("Invalid end date");
  let a = (_a2 = i.eval(r4, e)[0]) == null ? void 0 : _a2.value;
  if (a !== "years" && a !== "months" && a !== "days")
    throw new Error("Invalid units");
  let c = Te(o[0].value, s[0].value);
  return [{ type: u.Quantity, value: { value: c[a], unit: a } }];
}, is: (r4, e, t) => {
  let n = "";
  return t instanceof M ? n = t.name : t instanceof H && (n = t.left.name + "." + t.right.name), n ? e.map((i) => ({ type: u.boolean, value: Ae(i, n) })) : [];
}, not: (r4, e) => S.toBoolean(r4, e).map((t) => ({ type: u.boolean, value: !t.value })), resolve: (r4, e) => e.map((t) => {
  let n = t.value, i;
  if (typeof n == "string")
    i = n;
  else if (typeof n == "object") {
    let o = n;
    if (o.resource)
      return T(o.resource);
    o.reference ? i = o.reference : o.type && o.identifier && (i = `${o.type}?identifier=${o.identifier.system}|${o.identifier.value}`);
  }
  if (i == null ? void 0 : i.includes("?")) {
    let [o] = i.split("?");
    return { type: o, value: { resourceType: o } };
  }
  if (i == null ? void 0 : i.includes("/")) {
    let [o, s] = i.split("/");
    return { type: o, value: { resourceType: o, id: s } };
  }
  return { type: u.BackboneElement, value: void 0 };
}).filter((t) => !!t.value), as: (r4, e) => e, type: (r4, e) => e.map(({ value: t }) => typeof t == "boolean" ? { type: u.BackboneElement, value: { namespace: "System", name: "Boolean" } } : typeof t == "number" ? { type: u.BackboneElement, value: { namespace: "System", name: "Integer" } } : N(t) ? { type: u.BackboneElement, value: { namespace: "FHIR", name: t.resourceType } } : { type: u.BackboneElement, value: null }), conformsTo: (r4, e, t) => {
  let n = t.eval(r4, e)[0].value;
  if (!n.startsWith("http://hl7.org/fhir/StructureDefinition/"))
    throw new Error("Expected a StructureDefinition URL");
  let i = n.replace("http://hl7.org/fhir/StructureDefinition/", "");
  return e.map((o) => {
    var _a2;
    return { type: u.boolean, value: ((_a2 = o.value) == null ? void 0 : _a2.resourceType) === i };
  });
} };
function A(r4, e, t, ...n) {
  if (t.length === 0)
    return [];
  let [{ value: i }] = U(t, 1);
  if (typeof i != "string")
    throw new Error("String function cannot be called with non-string");
  let o = r4(i, ...n.map((s) => {
    var _a2;
    return (_a2 = s == null ? void 0 : s.eval(e, t)[0]) == null ? void 0 : _a2.value;
  }));
  return o === void 0 ? [] : Array.isArray(o) ? o.map(T) : [T(o)];
}
function _(r4, e, t, ...n) {
  if (t.length === 0)
    return [];
  let [{ value: i }] = U(t, 1), o = b(i), s = o ? i.value : i;
  if (typeof s != "number")
    throw new Error("Math function cannot be called with non-number");
  let a = r4(s, ...n.map((p) => {
    var _a2;
    return (_a2 = p.eval(e, t)[0]) == null ? void 0 : _a2.value;
  })), c = o ? u.Quantity : t[0].type, f = o ? { ...i, value: a } : a;
  return [{ type: c, value: f }];
}
function U(r4, e) {
  if (r4.length !== e)
    throw new Error(`Expected ${e} arguments`);
  for (let t of r4)
    if (t == null)
      throw new Error("Expected non-null argument");
  return r4;
}
var Ve = class {
  constructor(e, t) {
    this.original = e;
    this.child = t;
  }
  eval(e, t) {
    try {
      return t.length > 0 ? t.map((n) => this.child.eval(e, [n])).flat() : this.child.eval(e, []);
    } catch (n) {
      throw new Error(`FhirPathError on "${this.original}": ${n}`);
    }
  }
  toString() {
    return this.child.toString();
  }
};
var O = class {
  constructor(e) {
    this.value = e;
  }
  eval() {
    return [this.value];
  }
  toString() {
    let e = this.value.value;
    return typeof e == "string" ? `'${e}'` : e.toString();
  }
};
var M = class {
  constructor(e) {
    this.name = e;
  }
  eval(e, t) {
    if (this.name === "$this")
      return t;
    if (this.name.startsWith("%")) {
      let n = e.variables[this.name.slice(1)];
      if (!n)
        throw new Error(`Undefined variable ${this.name}`);
      return [n];
    }
    return t.flatMap((n) => this.evalValue(n)).filter((n) => (n == null ? void 0 : n.value) !== void 0);
  }
  evalValue(e) {
    let t = e.value;
    if (!(!t || typeof t != "object"))
      return N(t) && t.resourceType === this.name ? e : I(e, this.name);
  }
  toString() {
    return this.name;
  }
};
var De = class {
  eval() {
    return [];
  }
  toString() {
    return "{}";
  }
};
var Ne = class extends ge {
  constructor(t, n, i) {
    super(t, n);
    this.impl = i;
  }
  eval(t, n) {
    return this.impl(this.child.eval(t, n));
  }
  toString() {
    return this.operator + this.child.toString();
  }
};
var J = class extends $ {
  constructor(e, t) {
    super("as", e, t);
  }
  eval(e, t) {
    return S.ofType(e, this.left.eval(e, t), this.right);
  }
};
var v = class extends $ {
};
var R = class extends v {
  constructor(t, n, i, o) {
    super(t, n, i);
    this.impl = o;
  }
  eval(t, n) {
    let i = this.left.eval(t, n);
    if (i.length !== 1)
      return [];
    let o = this.right.eval(t, n);
    if (o.length !== 1)
      return [];
    let s = i[0].value, a = o[0].value, c = b(s) ? s.value : s, f = b(a) ? a.value : a, p = this.impl(c, f);
    return typeof p == "boolean" ? l(p) : b(s) ? [{ type: u.Quantity, value: { ...s, value: p } }] : [T(p)];
  }
};
var Fe = class extends $ {
  constructor(e, t) {
    super("&", e, t);
  }
  eval(e, t) {
    let n = this.left.eval(e, t), i = this.right.eval(e, t), o = [...n, ...i];
    return o.length > 0 && o.every((s) => typeof s.value == "string") ? [{ type: u.string, value: o.map((s) => s.value).join("") }] : o;
  }
};
var _e = class extends v {
  constructor(e, t) {
    super("contains", e, t);
  }
  eval(e, t) {
    let n = this.left.eval(e, t), i = this.right.eval(e, t);
    return l(n.some((o) => o.value === i[0].value));
  }
};
var Ue = class extends v {
  constructor(e, t) {
    super("in", e, t);
  }
  eval(e, t) {
    let n = D(this.left.eval(e, t)), i = this.right.eval(e, t);
    return n ? l(i.some((o) => o.value === n.value)) : [];
  }
};
var H = class extends $ {
  constructor(e, t) {
    super(".", e, t);
  }
  eval(e, t) {
    return this.right.eval(e, this.left.eval(e, t));
  }
  toString() {
    return `${this.left.toString()}.${this.right.toString()}`;
  }
};
var ne = class extends $ {
  constructor(e, t) {
    super("|", e, t);
  }
  eval(e, t) {
    let n = this.left.eval(e, t), i = this.right.eval(e, t);
    return Pe([...n, ...i]);
  }
};
var Le = class extends v {
  constructor(e, t) {
    super("=", e, t);
  }
  eval(e, t) {
    let n = this.left.eval(e, t), i = this.right.eval(e, t);
    return ut(n, i);
  }
};
var Me = class extends v {
  constructor(e, t) {
    super("!=", e, t);
  }
  eval(e, t) {
    let n = this.left.eval(e, t), i = this.right.eval(e, t);
    return ct(ut(n, i));
  }
};
var Be = class extends v {
  constructor(e, t) {
    super("~", e, t);
  }
  eval(e, t) {
    let n = this.left.eval(e, t), i = this.right.eval(e, t);
    return lt(n, i);
  }
};
var qe = class extends v {
  constructor(e, t) {
    super("!~", e, t);
  }
  eval(e, t) {
    let n = this.left.eval(e, t), i = this.right.eval(e, t);
    return ct(lt(n, i));
  }
};
var Y = class extends v {
  constructor(e, t) {
    super("is", e, t);
  }
  eval(e, t) {
    let n = this.left.eval(e, t);
    if (n.length !== 1)
      return [];
    let i = this.right.name;
    return l(Ae(n[0], i));
  }
};
var $e = class extends v {
  constructor(e, t) {
    super("and", e, t);
  }
  eval(e, t) {
    let n = D(this.left.eval(e, t), "boolean"), i = D(this.right.eval(e, t), "boolean");
    return (n == null ? void 0 : n.value) === true && (i == null ? void 0 : i.value) === true ? l(true) : (n == null ? void 0 : n.value) === false || (i == null ? void 0 : i.value) === false ? l(false) : [];
  }
};
var je = class extends v {
  constructor(e, t) {
    super("or", e, t);
  }
  eval(e, t) {
    let n = D(this.left.eval(e, t), "boolean"), i = D(this.right.eval(e, t), "boolean");
    return (n == null ? void 0 : n.value) === false && (i == null ? void 0 : i.value) === false ? l(false) : (n == null ? void 0 : n.value) || (i == null ? void 0 : i.value) ? l(true) : [];
  }
};
var Qe = class extends v {
  constructor(e, t) {
    super("xor", e, t);
  }
  eval(e, t) {
    let n = D(this.left.eval(e, t), "boolean"), i = D(this.right.eval(e, t), "boolean");
    return !n || !i ? [] : l(n.value !== i.value);
  }
};
var He = class extends v {
  constructor(e, t) {
    super("implies", e, t);
  }
  eval(e, t) {
    let n = D(this.left.eval(e, t), "boolean"), i = D(this.right.eval(e, t), "boolean");
    return (i == null ? void 0 : i.value) === true || (n == null ? void 0 : n.value) === false ? l(true) : !n || !i ? [] : l(false);
  }
};
var B = class {
  constructor(e, t) {
    this.name = e;
    this.args = t;
  }
  eval(e, t) {
    let n = S[this.name];
    if (!n)
      throw new Error("Unrecognized function: " + this.name);
    return n(e, t, ...this.args);
  }
  toString() {
    return `${this.name}(${this.args.map((e) => e.toString()).join(", ")})`;
  }
};
var X = class {
  constructor(e, t) {
    this.left = e;
    this.expr = t;
  }
  eval(e, t) {
    let n = this.expr.eval(e, t);
    if (n.length !== 1)
      return [];
    let i = n[0].value;
    if (typeof i != "number")
      throw new Error("Invalid indexer expression: should return integer}");
    let o = this.left.eval(e, t);
    return i in o ? [o[i]] : [];
  }
  toString() {
    return `${this.left.toString()}[${this.expr.toString()}]`;
  }
};
var ri = ["year", "years", "month", "months", "week", "weeks", "day", "days", "hour", "hours", "minute", "minutes", "second", "seconds", "millisecond", "milliseconds"];
var K = class {
  constructor(e, t, n, i) {
    this.result = [];
    this.pos = { index: 0, line: 1, column: 0 };
    this.markStack = [];
    this.str = e, this.keywords = t, this.operators = n, this.dateTimeLiterals = !!(i == null ? void 0 : i.dateTimeLiterals), this.symbolRegex = (i == null ? void 0 : i.symbolRegex) ?? /[$\w%]/;
  }
  tokenize() {
    for (; this.pos.index < this.str.length; ) {
      let e = this.consumeToken();
      e && this.result.push(e);
    }
    return this.result;
  }
  prevToken() {
    return this.result.slice(-1)[0];
  }
  peekToken() {
    this.mark();
    let e = this.consumeToken();
    return this.reset(), e;
  }
  consumeToken() {
    this.consumeWhitespace();
    let e = this.curr();
    if (!e)
      return;
    this.mark();
    let t = this.peek();
    return e === "/" && t === "*" ? this.consumeMultiLineComment() : e === "/" && t === "/" ? this.consumeSingleLineComment() : e === "'" || e === '"' ? this.consumeString(e) : e === "`" ? this.consumeBacktickSymbol() : e === "@" ? this.consumeDateTime() : /\d/.exec(e) ? this.consumeNumber() : /\w/.exec(e) ? this.consumeSymbol() : (e === "$" || e === "%") && /\w/.exec(t) ? this.consumeSymbol() : this.consumeOperator();
  }
  consumeWhitespace() {
    this.consumeWhile(() => /\s/.exec(this.curr()));
  }
  consumeMultiLineComment() {
    let e = this.pos.index;
    return this.consumeWhile(() => this.curr() !== "*" || this.peek() !== "/"), this.advance(), this.advance(), this.buildToken("Comment", this.str.substring(e, this.pos.index));
  }
  consumeSingleLineComment() {
    return this.buildToken("Comment", this.consumeWhile(() => this.curr() !== `
`));
  }
  consumeString(e) {
    this.advance();
    let t = this.buildToken("String", this.consumeWhile(() => this.prev() === "\\" || this.curr() !== e));
    return this.advance(), t;
  }
  consumeBacktickSymbol() {
    this.advance();
    let e = this.buildToken("Symbol", this.consumeWhile(() => this.curr() !== "`"));
    return this.advance(), e;
  }
  consumeDateTime() {
    this.advance();
    let e = this.pos.index;
    return this.consumeWhile(() => /[\d-]/.exec(this.curr())), this.curr() === "T" && (this.advance(), this.consumeWhile(() => /[\d:]/.exec(this.curr())), this.curr() === "." && /\d/.exec(this.peek()) && (this.advance(), this.consumeWhile(() => /\d/.exec(this.curr()))), this.curr() === "Z" ? this.advance() : (this.curr() === "+" || this.curr() === "-") && (this.advance(), this.consumeWhile(() => /[\d:]/.exec(this.curr())))), this.buildToken("DateTime", this.str.substring(e, this.pos.index));
  }
  consumeNumber() {
    let e = this.pos.index, t = "Number";
    return this.consumeWhile(() => /\d/.exec(this.curr())), this.curr() === "." && /\d/.exec(this.peek()) && (this.advance(), this.consumeWhile(() => /\d/.exec(this.curr()))), this.curr() === "-" && this.dateTimeLiterals ? (this.pos.index = e - 1, this.consumeDateTime()) : (this.curr() === " " && ni(this.peekToken()) && (t = "Quantity", this.consumeToken()), this.buildToken(t, this.str.substring(e, this.pos.index)));
  }
  consumeSymbol() {
    var _a2;
    let e = this.consumeWhile(() => this.symbolRegex.exec(this.curr()));
    return ((_a2 = this.prevToken()) == null ? void 0 : _a2.value) !== "." && this.keywords.includes(e) ? this.buildToken(e, e) : this.buildToken("Symbol", e);
  }
  consumeOperator() {
    let e = this.curr(), t = this.peek(), n = e + t;
    return this.operators.includes(n) ? (this.advance(), this.advance(), this.buildToken(n, n)) : (this.advance(), this.buildToken(e, e));
  }
  consumeWhile(e) {
    let t = this.pos.index;
    for (; this.pos.index < this.str.length && e(); )
      this.advance();
    return this.str.substring(t, this.pos.index);
  }
  curr() {
    return this.str[this.pos.index];
  }
  prev() {
    return this.str[this.pos.index - 1] ?? "";
  }
  peek() {
    return this.str[this.pos.index + 1] ?? "";
  }
  mark() {
    this.markStack.push({ ...this.pos });
  }
  reset() {
    let e = this.markStack.pop();
    if (!e)
      throw new Error("No mark to reset to");
    this.pos.index = e.index, this.pos.line = e.line, this.pos.column = e.column;
  }
  advance() {
    this.pos.index++, this.curr() === `
` ? (this.pos.line++, this.pos.column = 0) : this.pos.column++;
  }
  buildToken(e, t) {
    let n = this.markStack.pop();
    if (!n)
      throw new Error("No mark for token");
    return { id: e, value: t, ...n };
  }
};
function ni(r4) {
  return !!(r4 && (r4.id === "String" || r4.id === "Symbol" && ri.includes(r4.value)));
}
var ue = ["true", "false"];
var le = ["!=", "!~", "<=", ">=", "{}", "->"];
function Ir(r4) {
  return new K(r4, ue, le).tokenize();
}
var m = { FunctionCall: 0, Dot: 1, Indexer: 2, UnaryAdd: 3, UnarySubtract: 3, Multiply: 4, Divide: 4, IntegerDivide: 4, Modulo: 4, Add: 5, Subtract: 5, Ampersand: 5, Is: 6, As: 6, Union: 7, GreaterThan: 8, GreaterThanOrEquals: 8, LessThan: 8, LessThanOrEquals: 8, Equals: 9, Equivalent: 9, NotEquals: 9, NotEquivalent: 9, In: 10, Contains: 10, And: 11, Xor: 12, Or: 12, Implies: 13, Arrow: 100, Semicolon: 200 };
var ii = { parse(r4) {
  var _a2;
  let e = r4.consumeAndParse();
  if (!r4.match(")"))
    throw new Error("Parse error: expected `)` got `" + ((_a2 = r4.peek()) == null ? void 0 : _a2.value) + "`");
  return e;
} };
var oi = { parse(r4, e) {
  let t = r4.consumeAndParse();
  if (!r4.match("]"))
    throw new Error("Parse error: expected `]`");
  return new X(e, t);
}, precedence: m.Indexer };
var si = { parse(r4, e) {
  if (!(e instanceof M))
    throw new Error("Unexpected parentheses");
  let t = [];
  for (; !r4.match(")"); )
    t.push(r4.consumeAndParse()), r4.match(",");
  return new B(e.name, t);
}, precedence: m.FunctionCall };
function ai(r4) {
  let e = r4.split(" "), t = parseFloat(e[0]), n = e[1];
  return (n == null ? void 0 : n.startsWith("'")) && n.endsWith("'") ? n = n.substring(1, n.length - 1) : n = "{" + n + "}", { value: t, unit: n };
}
function de() {
  return new xe().registerPrefix("String", { parse: (r4, e) => new O({ type: u.string, value: e.value }) }).registerPrefix("DateTime", { parse: (r4, e) => new O({ type: u.dateTime, value: re(e.value) }) }).registerPrefix("Quantity", { parse: (r4, e) => new O({ type: u.Quantity, value: ai(e.value) }) }).registerPrefix("Number", { parse: (r4, e) => new O({ type: u.decimal, value: parseFloat(e.value) }) }).registerPrefix("true", { parse: () => new O({ type: u.boolean, value: true }) }).registerPrefix("false", { parse: () => new O({ type: u.boolean, value: false }) }).registerPrefix("Symbol", { parse: (r4, e) => new M(e.value) }).registerPrefix("{}", { parse: () => new De() }).registerPrefix("(", ii).registerInfix("[", oi).registerInfix("(", si).prefix("+", m.UnaryAdd, (r4, e) => new Ne("+", e, (t) => t)).prefix("-", m.UnarySubtract, (r4, e) => new R("-", e, e, (t, n) => -n)).infixLeft(".", m.Dot, (r4, e, t) => new H(r4, t)).infixLeft("/", m.Divide, (r4, e, t) => new R("/", r4, t, (n, i) => n / i)).infixLeft("*", m.Multiply, (r4, e, t) => new R("*", r4, t, (n, i) => n * i)).infixLeft("+", m.Add, (r4, e, t) => new R("+", r4, t, (n, i) => n + i)).infixLeft("-", m.Subtract, (r4, e, t) => new R("-", r4, t, (n, i) => n - i)).infixLeft("|", m.Union, (r4, e, t) => new ne(r4, t)).infixLeft("=", m.Equals, (r4, e, t) => new Le(r4, t)).infixLeft("!=", m.NotEquals, (r4, e, t) => new Me(r4, t)).infixLeft("~", m.Equivalent, (r4, e, t) => new Be(r4, t)).infixLeft("!~", m.NotEquivalent, (r4, e, t) => new qe(r4, t)).infixLeft("<", m.LessThan, (r4, e, t) => new R("<", r4, t, (n, i) => n < i)).infixLeft("<=", m.LessThanOrEquals, (r4, e, t) => new R("<=", r4, t, (n, i) => n <= i)).infixLeft(">", m.GreaterThan, (r4, e, t) => new R(">", r4, t, (n, i) => n > i)).infixLeft(">=", m.GreaterThanOrEquals, (r4, e, t) => new R(">=", r4, t, (n, i) => n >= i)).infixLeft("&", m.Ampersand, (r4, e, t) => new Fe(r4, t)).infixLeft("and", m.And, (r4, e, t) => new $e(r4, t)).infixLeft("as", m.As, (r4, e, t) => new J(r4, t)).infixLeft("contains", m.Contains, (r4, e, t) => new _e(r4, t)).infixLeft("div", m.Divide, (r4, e, t) => new R("div", r4, t, (n, i) => n / i | 0)).infixLeft("in", m.In, (r4, e, t) => new Ue(r4, t)).infixLeft("is", m.Is, (r4, e, t) => new Y(r4, t)).infixLeft("mod", m.Modulo, (r4, e, t) => new R("mod", r4, t, (n, i) => n % i)).infixLeft("or", m.Or, (r4, e, t) => new je(r4, t)).infixLeft("xor", m.Xor, (r4, e, t) => new Qe(r4, t)).infixLeft("implies", m.Implies, (r4, e, t) => new He(r4, t));
}
var ci = de();
function Rt(r4) {
  return new Ve(r4, ci.construct(Ir(r4)).consumeAndParse());
}
function ie(r4, e) {
  let t = Array.isArray(e) ? e : [e];
  for (let n = 0; n < t.length; n++) {
    let i = t[n];
    typeof i == "object" && "type" in i && "value" in i || (t[n] = T(t[n]));
  }
  return pe(r4, t).map((n) => n.value);
}
function pe(r4, e, t) {
  let n = t ?? {};
  return Rt(r4).eval({ variables: n }, e).map((o) => {
    var _a2;
    return { type: o.type, value: (_a2 = o.value) == null ? void 0 : _a2.valueOf() };
  });
}
var kr = ((p) => (p.BOOLEAN = "BOOLEAN", p.NUMBER = "NUMBER", p.QUANTITY = "QUANTITY", p.TEXT = "TEXT", p.REFERENCE = "REFERENCE", p.CANONICAL = "CANONICAL", p.DATE = "DATE", p.DATETIME = "DATETIME", p.PERIOD = "PERIOD", p.UUID = "UUID", p))(kr || {});
function Or(r4, e) {
  var _a2, _b;
  let t = (_b = (_a2 = k.types[r4]) == null ? void 0 : _a2.searchParamsDetails) == null ? void 0 : _b[e.code];
  return t || (t = li(r4, e)), t;
}
function ui(r4, e, t) {
  let n = k.types[r4];
  n.searchParamsDetails || (n.searchParamsDetails = {}), n.searchParamsDetails[e] = t;
}
function li(r4, e) {
  let t = e.code, n = fi(t), i = Dr(r4, e.expression), o = { elementDefinitions: [], propertyTypes: /* @__PURE__ */ new Set(), array: false };
  for (let a of i) {
    let c = fe(a);
    c.length === 1 && c[0] instanceof v ? o.propertyTypes.add("boolean") : Vr(o, fe(a), r4, 1);
  }
  let s = { columnName: n, type: mi(e, o.propertyTypes), elementDefinitions: o.elementDefinitions, array: o.array };
  return ui(r4, t, s), s;
}
function Vr(r4, e, t, n) {
  let i = e[n];
  if (i instanceof J) {
    r4.propertyTypes.add(i.right.toString());
    return;
  }
  if (i instanceof B) {
    di(r4, i);
    return;
  }
  let o = i.toString(), s = Ce(t, o);
  if (!s)
    throw new Error(`Element definition not found for ${t} ${o}`);
  let a = false, c = n + 1;
  if (c < e.length && e[c] instanceof X && (a = true, c++), s.isArray && !a && (r4.array = true), c >= e.length) {
    r4.elementDefinitions.push(s);
    for (let f of s.type)
      r4.propertyTypes.add(f.code);
    return;
  }
  for (let f of s.type) {
    let p = f.code;
    pi(p) && (p = s.type[0].code), Vr(r4, e, p, c);
  }
}
function di(r4, e) {
  if (e.name === "as") {
    r4.propertyTypes.add(e.args[0].toString());
    return;
  }
  if (e.name === "resolve") {
    r4.propertyTypes.add("string");
    return;
  }
  if (e.name === "where" && e.args[0] instanceof Y) {
    r4.propertyTypes.add(e.args[0].right.toString());
    return;
  }
  throw new Error(`Unhandled FHIRPath function: ${e.name}`);
}
function pi(r4) {
  return r4 === "Element" || r4 === "BackboneElement";
}
function fi(r4) {
  return r4.split("-").reduce((e, t, n) => e + (n ? P(t) : t), "");
}
function mi(r4, e) {
  switch (r4.type) {
    case "date":
      return e.size === 1 && e.has(u.date) ? "DATE" : "DATETIME";
    case "number":
      return "NUMBER";
    case "quantity":
      return "QUANTITY";
    case "reference":
      return e.has(u.canonical) ? "CANONICAL" : "REFERENCE";
    case "token":
      return e.size === 1 && e.has(u.boolean) ? "BOOLEAN" : "TEXT";
    default:
      return "TEXT";
  }
}
function Dr(r4, e) {
  let t = [], n = Rt(e);
  return Pt(r4, n.child, t), t;
}
function Ia(r4, e) {
  let t = Dr(r4, e);
  if (t.length !== 0)
    return t.map((n) => n.toString()).join(" | ");
}
function Pt(r4, e, t) {
  e instanceof ne ? (Pt(r4, e.left, t), Pt(r4, e.right, t)) : e.toString().startsWith(r4 + ".") && t.push(e);
}
function fe(r4) {
  return r4 instanceof J || r4 instanceof X ? [fe(r4.left), r4].flat() : r4 instanceof v ? [r4] : r4 instanceof H ? [fe(r4.left), fe(r4.right)].flat() : r4 instanceof B && r4.name === "where" && !(r4.args[0] instanceof Y) ? [] : [r4];
}
var Fa = 20;
var hi = ((g) => (g.EQUALS = "eq", g.NOT_EQUALS = "ne", g.GREATER_THAN = "gt", g.LESS_THAN = "lt", g.GREATER_THAN_OR_EQUALS = "ge", g.LESS_THAN_OR_EQUALS = "le", g.STARTS_AFTER = "sa", g.ENDS_BEFORE = "eb", g.APPROXIMATELY = "ap", g.CONTAINS = "contains", g.EXACT = "exact", g.TEXT = "text", g.NOT = "not", g.ABOVE = "above", g.BELOW = "below", g.IN = "in", g.NOT_IN = "not-in", g.OF_TYPE = "of-type", g.MISSING = "missing", g.IDENTIFIER = "identifier", g.ITERATE = "iterate", g))(hi || {});
var _r = { contains: "contains", exact: "exact", above: "above", below: "below", text: "text", not: "not", in: "in", "not-in": "not-in", "of-type": "of-type", missing: "missing", identifier: "identifier", iterate: "iterate" };
var Ct = { eq: "eq", ne: "ne", lt: "lt", le: "le", gt: "gt", ge: "ge", sa: "sa", eb: "eb", ap: "ap" };
function _a(r4, e) {
  let t = [];
  for (let [n, i] of Object.entries(e))
    if (Array.isArray(i))
      for (let o of i)
        t.push([n, o]);
    else
      t.push([n, i ?? ""]);
  return Lr(r4, t);
}
function Ur(r4) {
  let e;
  for (let t of r4.pathname.split("/"))
    t && (e = t);
  return Lr(e, r4.searchParams.entries());
}
function Ua(r4) {
  return Ur(new URL(r4, "https://example.com/"));
}
function wt(r4) {
  return Ur(new URL(r4, "https://api.medplum.com/"));
}
function Lr(r4, e) {
  let t = { resourceType: r4 };
  for (let [n, i] of e)
    yi(t, n, i);
  return t;
}
function yi(r4, e, t) {
  var _a2, _b;
  let n, i, o = e.indexOf(":");
  if (o >= 0 ? (n = e.substring(0, o), i = e.substring(o + 1)) : (n = e, i = ""), n === "_has" || e.includes(".")) {
    At(r4, { code: e, operator: "eq", value: t });
    return;
  }
  switch (n) {
    case "_sort":
      gi(r4, t);
      break;
    case "_count":
      r4.count = parseInt(t, 10);
      break;
    case "_offset":
      r4.offset = parseInt(t, 10);
      break;
    case "_total":
      r4.total = t;
      break;
    case "_summary":
      t === "count" ? (r4.total = "accurate", r4.count = 0) : (t === "true" || t === "data" || t === "text") && (r4.summary = t);
      break;
    case "_include": {
      let s = Nr(t);
      i === "iterate" && (s.modifier = "iterate"), r4.include ? r4.include.push(s) : r4.include = [s];
      break;
    }
    case "_revinclude": {
      let s = Nr(t);
      i === "iterate" && (s.modifier = "iterate"), r4.revInclude ? r4.revInclude.push(s) : r4.revInclude = [s];
      break;
    }
    case "_fields":
    case "_elements":
      r4.fields = t.split(",");
      break;
    default: {
      let s = (_b = (_a2 = k.types[r4.resourceType]) == null ? void 0 : _a2.searchParams) == null ? void 0 : _b[n];
      s ? At(r4, xi(s, i, t)) : At(r4, Si(n, i, t));
    }
  }
}
function gi(r4, e) {
  for (let t of e.split(",")) {
    let n, i = false;
    t.startsWith("-") ? (n = t.substring(1), i = true) : n = t, r4.sortRules || (r4.sortRules = []), r4.sortRules.push({ code: n, descending: i });
  }
}
function xi(r4, e, t) {
  if (e === "missing")
    return { code: r4.code, operator: "missing", value: t };
  switch (r4.type) {
    case "number":
    case "date":
    case "quantity":
      return Ti(r4, t);
    case "reference":
    case "string":
    case "token":
    case "uri":
      return vi(r4, e, t);
    default:
      throw new Error("Unrecognized search parameter type: " + r4.type);
  }
}
function Ti(r4, e) {
  let { operator: t, value: n } = Ei(e);
  return { code: r4.code, operator: t, value: n };
}
function vi(r4, e, t) {
  return { code: r4.code, operator: bi(e), value: t };
}
function Si(r4, e, t) {
  var _a2;
  let n = "eq";
  if (e)
    n = e;
  else if (t.length >= 2) {
    let i = t.substring(0, 2);
    i in Ct && (t.length === 2 || ((_a2 = t.at(2)) == null ? void 0 : _a2.match(/\d/))) && (n = i, t = t.substring(i.length));
  }
  return { code: r4, operator: n, value: t };
}
function Ei(r4) {
  let e = r4.substring(0, 2), t = Ct[e];
  return t ? { operator: t, value: r4.substring(2) } : { operator: "eq", value: r4 };
}
function bi(r4) {
  return _r[r4] ?? "eq";
}
function Nr(r4) {
  let e = r4.split(":");
  if (e.includes("*"))
    throw new d(F("'*' is not supported as a value for search inclusion parameters"));
  if (e.length === 1)
    throw new d(F(`Invalid include value '${r4}': must be of the form ResourceType:search-parameter`));
  if (e.length === 2)
    return { resourceType: e[0], searchParam: e[1] };
  if (e.length === 3)
    return { resourceType: e[0], searchParam: e[1], targetType: e[2] };
  throw new d(F(`Invalid include value '${r4}'`));
}
function At(r4, e) {
  r4.filters ? r4.filters.push(e) : r4.filters = [e];
}
var Ri = /{{([^{}]+)}}/g;
function La(r4, e) {
  return r4 = r4.replaceAll(Ri, (t, n) => {
    let i = pe(n, [], e);
    return i.length !== 1 ? "" : wr(i[0]);
  }), wt(r4);
}
function Ma(r4) {
  let e = [];
  return r4.fields && e.push("_fields=" + r4.fields.join(",")), r4.filters && r4.filters.forEach((t) => e.push(Pi(t))), r4.sortRules && r4.sortRules.length > 0 && e.push(Ai(r4.sortRules)), r4.offset !== void 0 && e.push("_offset=" + r4.offset), r4.count !== void 0 && e.push("_count=" + r4.count), r4.total !== void 0 && e.push("_total=" + r4.total), r4.include && r4.include.forEach((t) => e.push(Fr("_include", t))), r4.revInclude && r4.revInclude.forEach((t) => e.push(Fr("_revinclude", t))), e.length === 0 ? "" : (e.sort((t, n) => t.localeCompare(n)), "?" + e.join("&"));
}
function Pi(r4) {
  let e = r4.operator in _r ? ":" + r4.operator : "", t = r4.operator !== "eq" && r4.operator in Ct ? r4.operator : "";
  return `${r4.code}${e}=${t}${encodeURIComponent(r4.value)}`;
}
function Ai(r4) {
  return "_sort=" + r4.map((e) => e.descending ? "-" + e.code : e.code).join(",");
}
function Fr(r4, e) {
  return r4 + "=" + e.resourceType + ":" + e.searchParam + (e.targetType ? ":" + e.targetType : "");
}
function Mr(r4, e) {
  if (e.resourceType !== r4.resourceType)
    return false;
  if (e.filters) {
    for (let t of e.filters)
      if (!Ci(r4, e, t))
        return false;
  }
  return true;
}
function Ci(r4, e, t) {
  var _a2, _b;
  let n = (_b = (_a2 = k.types[e.resourceType]) == null ? void 0 : _a2.searchParams) == null ? void 0 : _b[t.code];
  if (t.operator === "missing" && n) {
    let i = ie(n.expression, r4);
    return t.value === "true" ? !i.length : i.length > 0;
  }
  switch (n == null ? void 0 : n.type) {
    case "reference":
      return wi(r4, t, n);
    case "string":
    case "uri":
      return Br(r4, t, n);
    case "token":
      return Ii(r4, t, n);
    case "date":
      return Oi(r4, t, n);
    default:
      return false;
  }
}
function wi(r4, e, t) {
  let n = ie(t.expression, r4), i = Ke(e.operator);
  if (e.value === "" && n.length === 0)
    return e.operator === "eq";
  let o = n.map((s) => typeof s == "string" ? s : s.reference);
  for (let s of e.value.split(",")) {
    let a = o.includes(s);
    if (!a && e.code === "_compartment" && (a = o.some((c) => c == null ? void 0 : c.endsWith("/" + s))), a)
      return !i;
  }
  return i;
}
function Ii(r4, e, t) {
  return Or(r4.resourceType, t).type === "BOOLEAN" ? ki(r4, e, t) : Br(r4, e, t, true);
}
function ki(r4, e, t) {
  let n = ie(t.expression, r4), i = e.value === "true", o = n.includes(i);
  return Ke(e.operator) ? !o : o;
}
function Br(r4, e, t, n) {
  let i = ie(t.expression, r4), o = e.value.split(","), s = Ke(e.operator);
  for (let a of i)
    for (let c of o)
      if (It(a, e.operator, c, n))
        return !s;
  return s;
}
function It(r4, e, t, n) {
  if (n && t.includes("|")) {
    let [o, s] = t.split("|");
    return It(r4, e, o, false) && (!s || It(r4, e, s, false));
  }
  let i = "";
  return r4 && (typeof r4 == "string" ? i = r4 : typeof r4 == "object" && (i = JSON.stringify(r4))), i.toLowerCase().includes(t.toLowerCase());
}
function Oi(r4, e, t) {
  let n = ie(t.expression, r4), i = e.value.split(","), o = Ke(e.operator);
  for (let s of n)
    for (let a of i)
      if (Vi(s, e.operator, a))
        return !o;
  return o;
}
function Vi(r4, e, t) {
  switch (e) {
    case "sa":
    case "gt":
      return r4 > t;
    case "ge":
      return r4 >= t;
    case "eb":
    case "lt":
      return r4 < t;
    case "le":
      return r4 <= t;
    case "eq":
    case "ne":
      return r4 === t;
    default:
      return false;
  }
}
function Ke(r4) {
  return r4 === "ne" || r4 === "not";
}
var Di = { resourceType: "*" };
var Ni = ["DomainConfiguration", "JsonWebKey", "Login"];
var Fi = ["PasswordChangeRequest", "Project", "ProjectMembership", "User"];
var _i = ((x) => (x.READ = "read", x.VREAD = "vread", x.UPDATE = "update", x.PATCH = "patch", x.DELETE = "delete", x.HISTORY = "history", x.HISTORY_INSTANCE = "history-instance", x.HISTORY_TYPE = "history-type", x.HISTORY_SYSTEM = "history-system", x.CREATE = "create", x.SEARCH = "search", x.SEARCH_TYPE = "search-type", x.SEARCH_SYSTEM = "search-system", x.SEARCH_COMPARTMENT = "search-compartment", x.CAPABILITIES = "capabilities", x.TRANSACTION = "transaction", x.BATCH = "batch", x.OPERATION = "operation", x))(_i || {});
var Ui = ["read", "vread", "history", "history-instance"];
function Wa(r4, e) {
  if (r4.resource) {
    for (let t of r4.resource)
      if (kt(t.resourceType, e))
        return true;
  }
  return false;
}
function Li(r4, e) {
  if (Ni.includes(e))
    return false;
  if (r4.resource) {
    for (let t of r4.resource)
      if (kt(t.resourceType, e) && !t.readonly)
        return true;
  }
  return false;
}
function Ga(r4, e) {
  let t = e.resourceType;
  return Li(r4, t) ? Mi(r4, e, false) : false;
}
function Mi(r4, e, t) {
  if (r4.resource) {
    for (let n of r4.resource)
      if (qr(e, t ? "read" : "update", n))
        return true;
  }
  return false;
}
function za(r4, e, t) {
  if (!t)
    return Di;
  if (t.resource) {
    for (let n of t.resource)
      if (qr(r4, e, n))
        return n;
  }
}
function qr(r4, e, t) {
  var _a2, _b;
  let n = r4.resourceType;
  return !(!kt(t.resourceType, n) || t.readonly && !Ui.includes(e) || t.compartment && !((_b = (_a2 = r4.meta) == null ? void 0 : _a2.compartment) == null ? void 0 : _b.find((i) => {
    var _a3;
    return i.reference === ((_a3 = t.compartment) == null ? void 0 : _a3.reference);
  })) || t.criteria && !Mr(r4, wt(t.criteria)));
}
function kt(r4, e) {
  return r4 === e || r4 === "*" && !Fi.includes(e);
}
function $r(r4) {
  if (typeof window < "u")
    return window.atob(r4);
  if (typeof Buffer < "u")
    return Buffer.from(r4, "base64").toString("binary");
  throw new Error("Unable to decode base64");
}
function jr(r4) {
  if (typeof window < "u")
    return window.btoa(r4);
  if (typeof Buffer < "u")
    return Buffer.from(r4, "binary").toString("base64");
  throw new Error("Unable to encode base64");
}
function Ot() {
  let r4 = new Uint32Array(28);
  return crypto.getRandomValues(r4), Xt(r4.buffer);
}
async function Qr(r4) {
  return crypto.subtle.digest("SHA-256", new TextEncoder().encode(r4));
}
function me() {
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (r4) => {
    let e = Math.random() * 16 | 0;
    return (r4 === "x" ? e : e & 3 | 8).toString(16);
  });
}
function Bi(r4) {
  var _a2, _b, _c;
  let e = {};
  r4 = it(r4);
  for (let i of r4.entry || []) {
    (_a2 = i.resource) == null ? true : delete _a2.meta;
    let o = (_b = i.resource) == null ? void 0 : _b.id;
    o && (e[o] = me(), i.fullUrl = "urn:uuid:" + e[o], (_c = i.resource) == null ? true : delete _c.id);
  }
  let t = r4.entry, n = JSON.stringify({ resourceType: "Bundle", type: "transaction", entry: t == null ? void 0 : t.map((i) => ({ fullUrl: i.fullUrl, request: { method: "POST", url: i.resource.resourceType }, resource: i.resource })) }, (i, o) => qi(i, o, e), 2);
  return $i(JSON.parse(n));
}
function qi(r4, e, t) {
  if (r4 === "reference" && typeof e == "string") {
    let n;
    if (e.includes("/") ? n = e.split("/")[1] : e.startsWith("urn:uuid:") ? n = e.slice(9) : e.startsWith("#") && (n = e.slice(1)), n) {
      let i = t[n];
      if (i)
        return "urn:uuid:" + i;
    }
  }
  return e;
}
function $i(r4) {
  let e = Qi(r4), { sorted: t, cycles: n } = ji(e), i = {};
  for (let s of r4.entry || [])
    s.fullUrl && (i[s.fullUrl] = s);
  let o = t.map((s) => i[s]);
  for (let s of n)
    for (let a of s) {
      let c = i[a], f = { ...c, request: { ...c.request, method: "PUT" } };
      o.push(f);
    }
  return { ...r4, entry: o };
}
function ji(r4) {
  let e = [], t = {}, n = [];
  for (let o of Object.keys(r4))
    t[o] = 0;
  function i(o, s) {
    if (t[o] === 2)
      return true;
    if (t[o] === 1) {
      let c = s.lastIndexOf(o);
      return c !== -1 && n.push(s.slice(c)), true;
    }
    t[o] = 1, s.push(o);
    let a = false;
    for (let c of r4[o])
      i(c, s) || (a = true);
    return t[o] = 2, s.pop(), e.unshift(o), !a;
  }
  for (let o in r4)
    t[o] === 0 && i(o, []);
  return { sorted: e, cycles: n };
}
function Hr(r4, e) {
  for (let t in r4)
    if (r4[t] && typeof r4[t] == "object") {
      let n = r4[t];
      if (ae(n)) {
        let i = n.reference;
        i.startsWith("urn:uuid:") && e(i);
      } else
        Hr(n, e);
    }
}
function Qi(r4) {
  let e = {};
  for (let t of r4.entry || [])
    t.fullUrl && (e[t.fullUrl] = []);
  for (let t of r4.entry || []) {
    let n = t.fullUrl;
    t.resource && Hr(t.resource, (i) => {
      e[i] && e[i].push(n);
    });
  }
  return e;
}
function nc(r4) {
  r4 = it(r4);
  let e = { resourceType: "Bundle", type: "transaction", entry: [{ resource: r4 }] };
  if (r4.contained) {
    for (let t of r4.contained)
      e.entry.push({ resource: t });
    r4.contained = void 0;
  }
  for (let t of e.entry)
    t.resource && !t.resource.id && (t.resource.id = me());
  return Bi(e);
}
var We = class {
  constructor(e = 10) {
    this.max = e, this.cache = /* @__PURE__ */ new Map();
  }
  clear() {
    this.cache.clear();
  }
  get(e) {
    let t = this.cache.get(e);
    return t && (this.cache.delete(e), this.cache.set(e, t)), t;
  }
  set(e, t) {
    this.cache.has(e) ? this.cache.delete(e) : this.cache.size >= this.max && this.cache.delete(this.first()), this.cache.set(e, t);
  }
  delete(e) {
    this.cache.delete(e);
  }
  keys() {
    return this.cache.keys();
  }
  first() {
    return this.cache.keys().next().value;
  }
};
var C = { CSS: "text/css", FAVICON: "image/vnd.microsoft.icon", FHIR_JSON: "application/fhir+json", FORM_URL_ENCODED: "application/x-www-form-urlencoded", HL7_V2: "x-application/hl7-v2+er7", HTML: "text/html", JAVASCRIPT: "text/javascript", JSON: "application/json", JSON_PATCH: "application/json-patch+json", PNG: "image/png", SVG: "image/svg+xml", TEXT: "text/plain", TYPESCRIPT: "text/typescript" };
var he = class {
  constructor() {
    this.listeners = {};
  }
  addEventListener(e, t) {
    this.listeners[e] || (this.listeners[e] = []), this.listeners[e].push(t);
  }
  removeEventListener(e, t) {
    let n = this.listeners[e];
    if (n) {
      for (let i = 0; i < n.length; i++)
        if (n[i] === t) {
          n.splice(i, 1);
          return;
        }
    }
  }
  dispatchEvent(e) {
    let t = this.listeners[e.type];
    if (t)
      for (let n of t)
        n.call(this, e);
    return !e.defaultPrevented;
  }
};
var Ge = class {
  constructor() {
    this.emitter = new he();
  }
  dispatchEvent(e) {
    this.emitter.dispatchEvent(e);
  }
  addEventListener(e, t) {
    this.emitter.addEventListener(e, t);
  }
  removeEventListener(e, t) {
    this.emitter.removeEventListener(e, t);
  }
};
var Vt = { "Patient-open": "Patient-open", "Patient-close": "Patient-close", "ImagingStudy-open": "ImagingStudy-open", "ImagingStudy-close": "ImagingStudy-close", "Encounter-open": "Encounter-open", "Encounter-close": "Encounter-close", "DiagnosticReport-open": "DiagnosticReport-open", "DiagnosticReport-close": "DiagnosticReport-close", "DiagnosticReport-select": "DiagnosticReport-select", "DiagnosticReport-update": "DiagnosticReport-update", syncerror: "syncerror" };
var Hi = ["Patient", "Encounter", "ImagingStudy", "DiagnosticReport", "OperationOutcome", "Bundle"];
var Dt = ["DiagnosticReport-update"];
function Wr(r4) {
  return Dt.includes(r4);
}
function Gr(r4) {
  if (Dt.includes(r4))
    throw new d(h(`'context.version' is required for '${r4}'.`));
}
var Ki = { "Patient-open": { patient: { resourceType: "Patient" }, encounter: { resourceType: "Encounter", optional: true } }, "Patient-close": { patient: { resourceType: "Patient" }, encounter: { resourceType: "Encounter", optional: true } }, "ImagingStudy-open": { study: { resourceType: "ImagingStudy" }, encounter: { resourceType: "Encounter", optional: true }, patient: { resourceType: "Patient", optional: true } }, "ImagingStudy-close": { study: { resourceType: "ImagingStudy" }, encounter: { resourceType: "Encounter", optional: true }, patient: { resourceType: "Patient", optional: true } }, "Encounter-open": { encounter: { resourceType: "Encounter" }, patient: { resourceType: "Patient" } }, "Encounter-close": { encounter: { resourceType: "Encounter" }, patient: { resourceType: "Patient" } }, "DiagnosticReport-open": { report: { resourceType: "DiagnosticReport" }, encounter: { resourceType: "Encounter", optional: true }, study: { resourceType: "ImagingStudy", optional: true, manyAllowed: true }, patient: { resourceType: "Patient" } }, "DiagnosticReport-close": { report: { resourceType: "DiagnosticReport" }, encounter: { resourceType: "Encounter", optional: true }, study: { resourceType: "ImagingStudy", optional: true, manyAllowed: true }, patient: { resourceType: "Patient" } }, "DiagnosticReport-select": { report: { resourceType: "DiagnosticReport" }, select: { resourceType: "*", isArray: true } }, "DiagnosticReport-update": { report: { resourceType: "DiagnosticReport" }, patient: { resourceType: "Patient", optional: true }, study: { resourceType: "ImagingStudy", optional: true }, updates: { resourceType: "Bundle" } }, syncerror: { operationoutcome: { resourceType: "OperationOutcome" } } };
function Wi(r4) {
  return Hi.includes(r4);
}
function zr(r4) {
  return !!r4.endpoint;
}
function Nt(r4) {
  if (!Je(r4))
    throw new d(h("subscriptionRequest must be an object conforming to SubscriptionRequest type."));
  let { channelType: e, mode: t, topic: n, events: i } = r4, o = { "hub.channel.type": e, "hub.mode": t, "hub.topic": n, "hub.events": i.join(",") };
  return zr(r4) && (o.endpoint = r4.endpoint), new URLSearchParams(o).toString();
}
function Je(r4) {
  if (typeof r4 != "object")
    return false;
  let { channelType: e, mode: t, topic: n, events: i } = r4;
  if (!(e && t && n && i) || typeof n != "string" || typeof i != "object" || !Array.isArray(i) || i.length < 1 || e !== "websocket" || t !== "subscribe" && t !== "unsubscribe")
    return false;
  for (let o of i)
    if (!Vt[o])
      return false;
  return !(zr(r4) && !(typeof r4.endpoint == "string" && r4.endpoint.startsWith("ws")));
}
function Kr(r4, e, t, n) {
  if (typeof e != "object")
    throw new d(h(`context[${t}] is invalid. Context must contain a single valid FHIR resource! Resource is not an object.`));
  if (!(e.id && typeof e.id == "string"))
    throw new d(h(`context[${t}] is invalid. Resource must contain a valid string ID.`));
  if (!e.resourceType)
    throw new d(h(`context[${t}] is invalid. Resource must contain a resource type. No resource type found.`));
  let i = n.resourceType;
  if (i !== "*") {
    if (!Wi(e.resourceType))
      throw new d(h(`context[${t}] is invalid. Resource must contain a valid FHIRcast resource type. Resource type is not a known resource type.`));
    if (i && e.resourceType !== i)
      throw new d(h(`context[${t}] is invalid. context[${t}] for the '${r4}' event should contain resource of type ${i}.`));
  }
}
function Gi(r4, e, t, n, i) {
  if (i.set(e.key, (i.get(e.key) ?? 0) + 1), !n.isArray)
    Kr(r4, e.resource, t, n);
  else {
    let { resources: o } = e;
    if (!o)
      throw new d(h(`context[${t}] is invalid. context[${t}] for the '${r4}' with key '${String(e.key)}' should contain an array of resources on the key 'resources'.`));
    for (let s of o)
      Kr(r4, s, t, n);
  }
}
function zi(r4, e) {
  let t = /* @__PURE__ */ new Map(), n = Ki[r4];
  for (let i = 0; i < e.length; i++) {
    let o = e[i].key;
    if (!n[o])
      throw new d(h(`Key '${o}' not found for event '${r4}'. Make sure to add only valid keys.`));
    Gi(r4, e[i], i, n[o], t);
  }
  for (let [i, o] of Object.entries(n)) {
    if (!(o.optional || t.has(i)))
      throw new d(h(`Missing required key '${i}' on context for '${r4}' event.`));
    if (!o.manyAllowed && (t.get(i) || 0) > 1)
      throw new d(h(`${t.get(i)} context entries with key '${i}' found for the '${r4}' event when schema only allows for 1.`));
  }
}
function Ft(r4, e, t, n) {
  if (!(r4 && typeof r4 == "string"))
    throw new d(h("Must provide a topic."));
  if (!Vt[e])
    throw new d(h(`Must provide a valid FHIRcast event name. Supported events: ${Object.keys(Vt).join(", ")}`));
  if (typeof t != "object")
    throw new d(h("context must be a context object or array of context objects."));
  if (Dt.includes(e) && !n)
    throw new d(h(`The '${e}' event must contain a 'context.versionId'.`));
  let i = Array.isArray(t) ? t : [t];
  return zi(e, i), { timestamp: (/* @__PURE__ */ new Date()).toISOString(), id: me(), event: { "hub.topic": r4, "hub.event": e, context: i, ...n ? { "context.versionId": n } : {} } };
}
var ze = class extends Ge {
  constructor(t) {
    super();
    if (this.subRequest = t, !t.endpoint)
      throw new d(h("Subscription request should contain an endpoint."));
    if (!Je(t))
      throw new d(h("Subscription request failed validation."));
    let n = new WebSocket(t.endpoint);
    n.addEventListener("open", () => {
      this.dispatchEvent({ type: "connect" }), n.addEventListener("message", (i) => {
        let o = JSON.parse(i.data);
        if (o["hub.topic"])
          return;
        let s = o;
        this.dispatchEvent({ type: "message", payload: s }), n.send(JSON.stringify({ id: o == null ? void 0 : o.id, timestamp: (/* @__PURE__ */ new Date()).toISOString() }));
      }), n.addEventListener("close", () => {
        this.dispatchEvent({ type: "disconnect" });
      });
    }), this.websocket = n;
  }
  disconnect() {
    this.websocket.close();
  }
};
function Ji(r4) {
  let e = r4.replace(/-/g, "+").replace(/_/g, "/"), t = $r(e), n = Array.from(t).reduce((o, s) => {
    let a = ("00" + s.charCodeAt(0).toString(16)).slice(-2);
    return `${o}%${a}`;
  }, ""), i = decodeURIComponent(n);
  return JSON.parse(i);
}
function Jr(r4) {
  return r4.split(".").length === 3;
}
function _t(r4) {
  let [e, t, n] = r4.split(".");
  return Ji(t);
}
function Yr(r4) {
  try {
    return typeof _t(r4).login_id == "string";
  } catch {
    return false;
  }
}
var Yi;
var w = class {
  constructor(e) {
    this[Yi] = "ReadablePromise";
    this.status = "pending";
    this.suspender = e.then((t) => (this.status = "success", this.response = t, t), (t) => {
      throw this.status = "error", this.error = t, t;
    });
  }
  isPending() {
    return this.status === "pending";
  }
  isOk() {
    return this.status === "success";
  }
  read() {
    switch (this.status) {
      case "pending":
        throw this.suspender;
      case "error":
        throw this.error;
      default:
        return this.response;
    }
  }
  then(e, t) {
    return this.suspender.then(e, t);
  }
  catch(e) {
    return this.suspender.catch(e);
  }
  finally(e) {
    return this.suspender.finally(e);
  }
};
Yi = Symbol.toStringTag;
var Ye = class {
  constructor() {
    this.storage = typeof localStorage < "u" ? localStorage : new Ut();
  }
  clear() {
    this.storage.clear();
  }
  getString(e) {
    return this.storage.getItem(e) ?? void 0;
  }
  setString(e, t) {
    t ? this.storage.setItem(e, t) : this.storage.removeItem(e);
  }
  getObject(e) {
    let t = this.getString(e);
    return t ? JSON.parse(t) : void 0;
  }
  setObject(e, t) {
    this.setString(e, t ? zt(t) : void 0);
  }
};
var Ut = class {
  constructor() {
    this.data = /* @__PURE__ */ new Map();
  }
  get length() {
    return this.data.size;
  }
  clear() {
    this.data.clear();
  }
  getItem(e) {
    return this.data.get(e) ?? null;
  }
  setItem(e, t) {
    t ? this.data.set(e, t) : this.data.delete(e);
  }
  removeItem(e) {
    this.data.delete(e);
  }
  key(e) {
    return Array.from(this.data.keys())[e];
  }
};
var Lc = "2.1.12-35ba0801";
var Xi = C.FHIR_JSON + ", */*; q=0.1";
var Zi = "https://api.medplum.com/";
var eo = 1e3;
var to = 6e4;
var Xr = "Binary/";
var Zr = { resourceType: "Device", id: "system", deviceName: [{ name: "System" }] };
var ro = ((o) => (o.ClientCredentials = "client_credentials", o.AuthorizationCode = "authorization_code", o.RefreshToken = "refresh_token", o.JwtBearer = "urn:ietf:params:oauth:grant-type:jwt-bearer", o.TokenExchange = "urn:ietf:params:oauth:grant-type:token-exchange", o))(ro || {});
var no = ((o) => (o.AccessToken = "urn:ietf:params:oauth:token-type:access_token", o.RefreshToken = "urn:ietf:params:oauth:token-type:refresh_token", o.IdToken = "urn:ietf:params:oauth:token-type:id_token", o.Saml1Token = "urn:ietf:params:oauth:token-type:saml1", o.Saml2Token = "urn:ietf:params:oauth:token-type:saml2", o))(no || {});
var io = ((o) => (o.ClientSecretBasic = "client_secret_basic", o.ClientSecretPost = "client_secret_post", o.ClientSecretJwt = "client_secret_jwt", o.PrivateKeyJwt = "private_key_jwt", o.None = "none", o))(io || {});
var oo = ((e) => (e.JwtBearer = "urn:ietf:params:oauth:client-assertion-type:jwt-bearer", e))(oo || {});
var en = class extends he {
  constructor(t) {
    super();
    if ((t == null ? void 0 : t.baseUrl) && !t.baseUrl.startsWith("http"))
      throw new Error("Base URL must start with http or https");
    if (this.options = t ?? {}, this.fetch = (t == null ? void 0 : t.fetch) ?? so(), this.storage = (t == null ? void 0 : t.storage) ?? new Ye(), this.createPdfImpl = t == null ? void 0 : t.createPdf, this.baseUrl = rn((t == null ? void 0 : t.baseUrl) ?? Zi), this.fhirBaseUrl = rn(Xe(this.baseUrl, (t == null ? void 0 : t.fhirUrlPath) ?? "fhir/R4/")), this.authorizeUrl = Xe(this.baseUrl, (t == null ? void 0 : t.authorizeUrl) ?? "oauth2/authorize"), this.tokenUrl = Xe(this.baseUrl, (t == null ? void 0 : t.tokenUrl) ?? "oauth2/token"), this.logoutUrl = Xe(this.baseUrl, (t == null ? void 0 : t.logoutUrl) ?? "oauth2/logout"), this.clientId = (t == null ? void 0 : t.clientId) ?? "", this.clientSecret = (t == null ? void 0 : t.clientSecret) ?? "", this.onUnauthenticated = t == null ? void 0 : t.onUnauthenticated, this.cacheTime = (t == null ? void 0 : t.cacheTime) ?? to, this.cacheTime > 0 ? this.requestCache = new We((t == null ? void 0 : t.resourceCacheSize) ?? eo) : this.requestCache = void 0, (t == null ? void 0 : t.autoBatchTime) ? (this.autoBatchTime = t.autoBatchTime, this.autoBatchQueue = []) : (this.autoBatchTime = 0, this.autoBatchQueue = void 0), t == null ? void 0 : t.accessToken)
      this.setAccessToken(t.accessToken);
    else {
      let n = this.getActiveLogin();
      n && (this.setAccessToken(n.accessToken, n.refreshToken), this.refreshProfile().catch(console.log));
    }
    this.setupStorageListener();
  }
  getBaseUrl() {
    return this.baseUrl;
  }
  getAuthorizeUrl() {
    return this.authorizeUrl;
  }
  getTokenUrl() {
    return this.tokenUrl;
  }
  getLogoutUrl() {
    return this.logoutUrl;
  }
  clear() {
    this.storage.clear(), sessionStorage.clear(), this.clearActiveLogin();
  }
  clearActiveLogin() {
    var _a2;
    this.storage.setString("activeLogin", void 0), (_a2 = this.requestCache) == null ? void 0 : _a2.clear(), this.accessToken = void 0, this.refreshToken = void 0, this.sessionDetails = void 0, this.medplumServer = void 0, this.dispatchEvent({ type: "change" });
  }
  invalidateUrl(t) {
    var _a2;
    t = t.toString(), (_a2 = this.requestCache) == null ? void 0 : _a2.delete(t);
  }
  invalidateAll() {
    var _a2;
    (_a2 = this.requestCache) == null ? void 0 : _a2.clear();
  }
  invalidateSearches(t) {
    let n = this.fhirBaseUrl + t;
    if (this.requestCache)
      for (let i of this.requestCache.keys())
        (i.endsWith(n) || i.includes(n + "?")) && this.requestCache.delete(i);
  }
  get(t, n = {}) {
    t = t.toString();
    let i = this.getCacheEntry(t, n);
    if (i)
      return i.value;
    let o;
    t.startsWith(this.fhirBaseUrl) && this.autoBatchQueue ? o = new Promise((a, c) => {
      this.autoBatchQueue.push({ method: "GET", url: t.replace(this.fhirBaseUrl, ""), options: n, resolve: a, reject: c }), this.autoBatchTimerId || (this.autoBatchTimerId = setTimeout(() => this.executeAutoBatch(), this.autoBatchTime));
    }) : o = this.request("GET", t, n);
    let s = new w(o);
    return this.setCacheEntry(t, s), s;
  }
  post(t, n, i, o = {}) {
    return t = t.toString(), this.setRequestBody(o, n), i && this.setRequestContentType(o, i), this.invalidateUrl(t), this.request("POST", t, o);
  }
  put(t, n, i, o = {}) {
    return t = t.toString(), this.setRequestBody(o, n), i && this.setRequestContentType(o, i), this.invalidateUrl(t), this.request("PUT", t, o);
  }
  patch(t, n, i = {}) {
    return t = t.toString(), this.setRequestBody(i, n), this.setRequestContentType(i, C.JSON_PATCH), this.invalidateUrl(t), this.request("PATCH", t, i);
  }
  delete(t, n) {
    return t = t.toString(), this.invalidateUrl(t), this.request("DELETE", t, n);
  }
  async startNewUser(t, n) {
    let { codeChallengeMethod: i, codeChallenge: o } = await this.startPkce();
    return this.post("auth/newuser", { ...t, clientId: t.clientId ?? this.clientId, codeChallengeMethod: i, codeChallenge: o }, void 0, n);
  }
  async startNewProject(t, n) {
    return this.post("auth/newproject", t, void 0, n);
  }
  async startNewPatient(t, n) {
    return this.post("auth/newpatient", t, void 0, n);
  }
  async startLogin(t, n) {
    return this.post("auth/login", { ...await this.ensureCodeChallenge(t), clientId: t.clientId ?? this.clientId, scope: t.scope }, void 0, n);
  }
  async startGoogleLogin(t, n) {
    return this.post("auth/google", { ...await this.ensureCodeChallenge(t), clientId: t.clientId ?? this.clientId, scope: t.scope }, void 0, n);
  }
  async ensureCodeChallenge(t) {
    return t.codeChallenge ? t : { ...t, ...await this.startPkce() };
  }
  async signOut() {
    await this.post(this.logoutUrl, {}), this.clear();
  }
  async signInWithRedirect(t) {
    let i = new URLSearchParams(window.location.search).get("code");
    if (i)
      return this.processCode(i);
    await this.requestAuthorization(t);
  }
  signOutWithRedirect() {
    window.location.assign(this.logoutUrl);
  }
  async signInWithExternalAuth(t, n, i, o, s = true) {
    let a = o;
    s && (a = await this.ensureCodeChallenge(o)), window.location.assign(this.getExternalAuthRedirectUri(t, n, i, a, s));
  }
  async exchangeExternalAccessToken(t, n) {
    if (n = n ?? this.clientId, !n)
      throw new Error("MedplumClient is missing clientId");
    let i = new URLSearchParams();
    return i.set("grant_type", "urn:ietf:params:oauth:grant-type:token-exchange"), i.set("subject_token_type", "urn:ietf:params:oauth:token-type:access_token"), i.set("client_id", n), i.set("subject_token", t), this.fetchTokens(i);
  }
  getExternalAuthRedirectUri(t, n, i, o, s = true) {
    let a = new URL(t);
    if (a.searchParams.set("response_type", "code"), a.searchParams.set("client_id", n), a.searchParams.set("redirect_uri", i), a.searchParams.set("scope", "openid profile email"), a.searchParams.set("state", JSON.stringify(o)), s) {
      let { codeChallenge: c, codeChallengeMethod: f } = o;
      if (!f)
        throw new Error("`LoginRequest` for external auth must include a `codeChallengeMethod`.");
      if (!c)
        throw new Error("`LoginRequest` for external auth must include a `codeChallenge`.");
      a.searchParams.set("code_challenge_method", f), a.searchParams.set("code_challenge", c);
    }
    return a.toString();
  }
  fhirUrl(...t) {
    return new URL(t.join("/"), this.fhirBaseUrl);
  }
  fhirSearchUrl(t, n) {
    let i = this.fhirUrl(t);
    return n && (i.search = new URLSearchParams(n).toString()), i;
  }
  search(t, n, i) {
    let o = this.fhirSearchUrl(t, n), s = o.toString() + "-search", a = this.getCacheEntry(s, i);
    if (a)
      return a.value;
    let c = new w((async () => {
      let f = await this.get(o, i);
      if (f.entry)
        for (let p of f.entry)
          this.cacheResource(p.resource);
      return f;
    })());
    return this.setCacheEntry(s, c), c;
  }
  searchOne(t, n, i) {
    let o = this.fhirSearchUrl(t, n);
    o.searchParams.set("_count", "1"), o.searchParams.sort();
    let s = o.toString() + "-searchOne", a = this.getCacheEntry(s, i);
    if (a)
      return a.value;
    let c = new w(this.search(t, o.searchParams, i).then((f) => {
      var _a2, _b;
      return (_b = (_a2 = f.entry) == null ? void 0 : _a2[0]) == null ? void 0 : _b.resource;
    }));
    return this.setCacheEntry(s, c), c;
  }
  searchResources(t, n, i) {
    let s = this.fhirSearchUrl(t, n).toString() + "-searchResources", a = this.getCacheEntry(s, i);
    if (a)
      return a.value;
    let c = new w(this.search(t, n, i).then(on));
    return this.setCacheEntry(s, c), c;
  }
  async *searchResourcePages(t, n, i) {
    var _a2, _b;
    let o = this.fhirSearchUrl(t, n);
    for (; o; ) {
      let s = new URL(o).searchParams, a = await this.search(t, s, i), c = (_a2 = a.link) == null ? void 0 : _a2.find((f) => f.relation === "next");
      if (!((_b = a.entry) == null ? void 0 : _b.length) && !c)
        break;
      yield on(a), o = (c == null ? void 0 : c.url) ? new URL(c.url) : void 0;
    }
  }
  searchValueSet(t, n, i) {
    let o = this.fhirUrl("ValueSet", "$expand");
    return o.searchParams.set("url", t), o.searchParams.set("filter", n), this.get(o.toString(), i);
  }
  getCached(t, n) {
    var _a2, _b;
    let i = (_b = (_a2 = this.requestCache) == null ? void 0 : _a2.get(this.fhirUrl(t, n).toString())) == null ? void 0 : _b.value;
    return (i == null ? void 0 : i.isOk()) ? i.read() : void 0;
  }
  getCachedReference(t) {
    let n = t.reference;
    if (!n)
      return;
    if (n === "system")
      return Zr;
    let [i, o] = n.split("/");
    if (!(!i || !o))
      return this.getCached(i, o);
  }
  readResource(t, n, i) {
    return this.get(this.fhirUrl(t, n), i);
  }
  readReference(t, n) {
    let i = t.reference;
    if (!i)
      return new w(Promise.reject(new Error("Missing reference")));
    if (i === "system")
      return new w(Promise.resolve(Zr));
    let [o, s] = i.split("/");
    return !o || !s ? new w(Promise.reject(new Error("Invalid reference"))) : this.readResource(o, s, n);
  }
  requestSchema(t) {
    if (Rr(t))
      return Promise.resolve();
    let n = t + "-requestSchema", i = this.getCacheEntry(n, void 0);
    if (i)
      return i.value;
    let o = new w((async () => {
      let s = `{
      StructureDefinitionList(name: "${t}") {
        resourceType,
        name,
        kind,
        description,
        snapshot {
          element {
            id,
            path,
            definition,
            min,
            max,
            base {
              path,
              min,
              max
            },
            contentReference,
            type {
              code,
              targetProfile
            },
            binding {
              strength,
              valueSet
            }
          }
        }
      }
      SearchParameterList(base: "${t}", _count: 100) {
        base,
        code,
        type,
        expression,
        target
      }
    }`.replace(/\s+/g, " "), a = await this.graphql(s);
      Er(a.data.StructureDefinitionList);
      for (let c of a.data.SearchParameterList)
        bt(c);
    })());
    return this.setCacheEntry(n, o), o;
  }
  readHistory(t, n, i) {
    return this.get(this.fhirUrl(t, n, "_history"), i);
  }
  readVersion(t, n, i, o) {
    return this.get(this.fhirUrl(t, n, "_history", i), o);
  }
  readPatientEverything(t, n) {
    return this.get(this.fhirUrl("Patient", t, "$everything"), n);
  }
  createResource(t, n) {
    if (!t.resourceType)
      throw new Error("Missing resourceType");
    return this.invalidateSearches(t.resourceType), this.post(this.fhirUrl(t.resourceType), t, void 0, n);
  }
  async createResourceIfNoneExist(t, n, i) {
    return await this.searchOne(t.resourceType, n, i) ?? this.createResource(t, i);
  }
  async createAttachment(t, n, i, o) {
    let s = await this.createBinary(t, n, i, o);
    return { contentType: i, url: s.url, title: n };
  }
  createBinary(t, n, i, o) {
    let s = this.fhirUrl("Binary");
    return n && s.searchParams.set("_filename", n), o ? this.uploadwithProgress(s, t, i, o) : this.post(s, t, i);
  }
  uploadwithProgress(t, n, i, o) {
    return new Promise((s, a) => {
      let c = new XMLHttpRequest();
      c.responseType = "json", c.onabort = () => a(new Error("Request aborted")), c.onerror = () => a(new Error("Request error")), o && (c.upload.onprogress = (f) => o(f), c.upload.onload = (f) => o(f)), c.onload = () => {
        c.status >= 200 && c.status < 300 ? s(c.response) : a(new d(Oe(c.response || c.statusText)));
      }, c.open("POST", t), c.withCredentials = true, c.setRequestHeader("Authorization", "Bearer " + this.accessToken), c.setRequestHeader("Cache-Control", "no-cache, no-store, max-age=0"), c.setRequestHeader("Content-Type", i), c.setRequestHeader("X-Medplum", "extended"), c.send(n);
    });
  }
  async createPdf(t, n, i, o) {
    if (!this.createPdfImpl)
      throw new Error("PDF creation not enabled");
    let s = await this.createPdfImpl(t, i, o);
    return this.createBinary(s, n, "application/pdf");
  }
  createComment(t, n, i) {
    let o = this.getProfile(), s, a;
    return t.resourceType === "Encounter" && (s = G(t), a = t.subject), t.resourceType === "ServiceRequest" && (s = t.encounter, a = t.subject), t.resourceType === "Patient" && (a = G(t)), this.createResource({ resourceType: "Communication", basedOn: [G(t)], encounter: s, subject: a, sender: o ? G(o) : void 0, sent: (/* @__PURE__ */ new Date()).toISOString(), payload: [{ contentString: n }] }, i);
  }
  async updateResource(t, n) {
    if (!t.resourceType)
      throw new Error("Missing resourceType");
    if (!t.id)
      throw new Error("Missing id");
    this.invalidateSearches(t.resourceType);
    let i = await this.put(this.fhirUrl(t.resourceType, t.id), t, void 0, n);
    return i || (i = t), this.cacheResource(i), i;
  }
  patchResource(t, n, i, o) {
    return this.invalidateSearches(t), this.patch(this.fhirUrl(t, n), i, o);
  }
  deleteResource(t, n, i) {
    return this.deleteCacheEntry(this.fhirUrl(t, n).toString()), this.invalidateSearches(t), this.delete(this.fhirUrl(t, n), i);
  }
  validateResource(t, n) {
    return this.post(this.fhirUrl(t.resourceType, "$validate"), t, void 0, n);
  }
  executeBot(t, n, i, o) {
    let s;
    if (typeof t == "string") {
      let a = t;
      s = this.fhirUrl("Bot", a, "$execute");
    } else {
      let a = t;
      s = this.fhirUrl("Bot", "$execute") + `?identifier=${a.system}|${a.value}`;
    }
    return this.post(s, n, i, o);
  }
  executeBatch(t, n) {
    return this.post(this.fhirBaseUrl.slice(0, -1), t, void 0, n);
  }
  sendEmail(t, n) {
    return this.post("email/v1/send", t, C.JSON, n);
  }
  graphql(t, n, i, o) {
    return this.post(this.fhirUrl("$graphql"), { query: t, operationName: n, variables: i }, C.JSON, o);
  }
  readResourceGraph(t, n, i, o) {
    return this.get(`${this.fhirUrl(t, n)}/$graph?graph=${i}`, o);
  }
  pushToAgent(t, n, i, o, s) {
    return this.post(this.fhirUrl("Agent", Kt(t), "$push"), { destination: se(n), body: i, contentType: o }, C.FHIR_JSON, s);
  }
  getActiveLogin() {
    return this.storage.getObject("activeLogin");
  }
  async setActiveLogin(t) {
    var _a2, _b;
    (!((_a2 = this.sessionDetails) == null ? void 0 : _a2.profile) || se(this.sessionDetails.profile) !== ((_b = t.profile) == null ? void 0 : _b.reference)) && this.clearActiveLogin(), this.setAccessToken(t.accessToken, t.refreshToken), this.storage.setObject("activeLogin", t), this.addLogin(t), this.refreshPromise = void 0, await this.refreshProfile();
  }
  getAccessToken() {
    return this.accessToken;
  }
  setAccessToken(t, n) {
    this.accessToken = t, this.refreshToken = n, this.sessionDetails = void 0, this.medplumServer = Yr(t);
  }
  getLogins() {
    return this.storage.getObject("logins") ?? [];
  }
  addLogin(t) {
    let n = this.getLogins().filter((i) => {
      var _a2, _b;
      return ((_a2 = i.profile) == null ? void 0 : _a2.reference) !== ((_b = t.profile) == null ? void 0 : _b.reference);
    });
    n.push(t), this.storage.setObject("logins", n);
  }
  async refreshProfile() {
    return this.medplumServer ? (this.profilePromise = new Promise((t, n) => {
      this.get("auth/me").then((i) => {
        var _a2, _b;
        this.profilePromise = void 0;
        let o = ((_b = (_a2 = this.sessionDetails) == null ? void 0 : _a2.profile) == null ? void 0 : _b.id) !== i.profile.id;
        this.sessionDetails = i, o && this.dispatchEvent({ type: "change" }), t(i.profile);
      }).catch(n);
    }), this.profilePromise) : Promise.resolve(void 0);
  }
  isLoading() {
    return !!this.profilePromise;
  }
  isSuperAdmin() {
    var _a2;
    return !!((_a2 = this.sessionDetails) == null ? void 0 : _a2.project.superAdmin);
  }
  isProjectAdmin() {
    var _a2;
    return !!((_a2 = this.sessionDetails) == null ? void 0 : _a2.membership.admin);
  }
  getProject() {
    var _a2;
    return (_a2 = this.sessionDetails) == null ? void 0 : _a2.project;
  }
  getProjectMembership() {
    var _a2;
    return (_a2 = this.sessionDetails) == null ? void 0 : _a2.membership;
  }
  getProfile() {
    var _a2;
    return (_a2 = this.sessionDetails) == null ? void 0 : _a2.profile;
  }
  async getProfileAsync() {
    return this.profilePromise ? this.profilePromise : this.sessionDetails ? this.sessionDetails.profile : this.refreshProfile();
  }
  getUserConfiguration() {
    var _a2;
    return (_a2 = this.sessionDetails) == null ? void 0 : _a2.config;
  }
  getAccessPolicy() {
    var _a2;
    return (_a2 = this.sessionDetails) == null ? void 0 : _a2.accessPolicy;
  }
  async download(t, n = {}) {
    this.refreshPromise && await this.refreshPromise;
    let i = t.toString();
    return i.startsWith(Xr) && (t = this.fhirUrl(i)), this.addFetchOptionsDefaults(n), (await this.fetchWithRetry(t.toString(), n)).blob();
  }
  async uploadMedia(t, n, i, o, s) {
    let a = await this.createBinary(t, i, n);
    return this.createResource({ resourceType: "Media", status: "completed", content: { contentType: n, url: Xr + a.id, title: i }, ...o }, s);
  }
  async bulkExport(t = "", n, i, o) {
    let s = t && `${t}/`, a = this.fhirUrl(`${s}$export`);
    return n && a.searchParams.set("_type", n), i && a.searchParams.set("_since", i), this.startAsyncRequest(a.toString(), o);
  }
  async startAsyncRequest(t, n = {}) {
    this.addFetchOptionsDefaults(n);
    let i = n.headers;
    i.Prefer = "respond-async";
    let o = await this.fetchWithRetry(t, n);
    if (o.status === 202) {
      let s = await nn(o);
      if (s)
        return this.pollStatus(s);
    }
    return this.parseResponse(o, "POST", t);
  }
  getCacheEntry(t, n) {
    if (!this.requestCache || (n == null ? void 0 : n.cache) === "no-cache" || (n == null ? void 0 : n.cache) === "reload")
      return;
    let i = this.requestCache.get(t);
    if (!(!i || i.requestTime + this.cacheTime < Date.now()))
      return i;
  }
  setCacheEntry(t, n) {
    this.requestCache && this.requestCache.set(t, { requestTime: Date.now(), value: n });
  }
  cacheResource(t) {
    var _a2, _b;
    (t == null ? void 0 : t.id) && !((_b = (_a2 = t.meta) == null ? void 0 : _a2.tag) == null ? void 0 : _b.some((n) => n.code === "SUBSETTED")) && this.setCacheEntry(this.fhirUrl(t.resourceType, t.id).toString(), new w(Promise.resolve(t)));
  }
  deleteCacheEntry(t) {
    this.requestCache && this.requestCache.delete(t);
  }
  async request(t, n, i = {}) {
    this.refreshPromise && await this.refreshPromise, i.method = t, this.addFetchOptionsDefaults(i);
    let o = await this.fetchWithRetry(n, i);
    return this.parseResponse(o, t, n, i);
  }
  async parseResponse(t, n, i, o = {}) {
    var _a2;
    if (t.status === 401)
      return this.handleUnauthenticated(n, i, o);
    if (t.status === 204 || t.status === 304)
      return;
    let a = (_a2 = t.headers.get("content-type")) == null ? void 0 : _a2.includes("json");
    if (t.status === 404 && !a)
      throw new d(mr);
    let c = t.headers.get("content-location"), f = o.redirect ?? this.options.redirect;
    if (t.status === 201 && c && f === "follow")
      return this.request("GET", c, { ...o, body: void 0 });
    let p;
    if (a)
      try {
        p = await t.json();
      } catch (q) {
        throw console.error("Error parsing response", t.status, q), q;
      }
    else
      p = await t.text();
    if (t.status >= 400)
      throw new d(Oe(p));
    return p;
  }
  async fetchWithRetry(t, n) {
    t.startsWith("http") || (t = new URL(t, this.baseUrl).href);
    let i = 3, o = 200, s;
    for (let a = 0; a < i; a++) {
      try {
        if (this.options.verbose && this.logRequest(t, n), s = await this.fetch(t, n), this.options.verbose && this.logResponse(s), s.status < 500)
          return s;
      } catch (c) {
        this.retryCatch(a, i, c);
      }
      await ot(o);
    }
    return s;
  }
  logRequest(t, n) {
    if (console.log(`> ${n.method} ${t}`), n.headers) {
      let i = n.headers, o = Object.entries(i).sort((s, a) => s[0].localeCompare(a[0]));
      for (let [s, a] of o)
        console.log(`> ${s}: ${a}`);
    }
  }
  logResponse(t) {
    console.log(`< ${t.status} ${t.statusText}`), t.headers && t.headers.forEach((n, i) => console.log(`< ${i}: ${n}`));
  }
  async pollStatus(t) {
    let n = true, i, o = 2e3;
    for (; n; ) {
      let s = {};
      this.addFetchOptionsDefaults(s);
      let a = await this.fetchWithRetry(t, s);
      if (a.status !== 202 && (n = false, i = a, a.status === 201)) {
        let c = await nn(a);
        c && (i = await this.fetchWithRetry(c, s));
      }
      await ot(o);
    }
    return this.parseResponse(i, "POST", t);
  }
  async executeAutoBatch() {
    var _a2, _b;
    let t = [...this.autoBatchQueue];
    if (this.autoBatchQueue.length = 0, this.autoBatchTimerId = void 0, t.length === 1) {
      let o = t[0];
      try {
        o.resolve(await this.request(o.method, this.fhirBaseUrl + o.url, o.options));
      } catch (s) {
        o.reject(new d(Oe(s)));
      }
      return;
    }
    let n = { resourceType: "Bundle", type: "batch", entry: t.map((o) => ({ request: { method: o.method, url: o.url }, resource: o.options.body ? JSON.parse(o.options.body) : void 0 })) }, i = await this.post(this.fhirBaseUrl.slice(0, -1), n);
    for (let o = 0; o < t.length; o++) {
      let s = t[o], a = (_a2 = i.entry) == null ? void 0 : _a2[o];
      ((_b = a == null ? void 0 : a.response) == null ? void 0 : _b.outcome) && !yt(a.response.outcome) ? s.reject(new d(a.response.outcome)) : s.resolve(a == null ? void 0 : a.resource);
    }
  }
  addFetchOptionsDefaults(t) {
    let n = t.headers;
    n || (n = {}, t.headers = n), n.Accept || (n.Accept = Xi), n["X-Medplum"] = "extended", t.body && !n["Content-Type"] && (n["Content-Type"] = C.FHIR_JSON), this.accessToken ? n.Authorization = "Bearer " + this.accessToken : this.basicAuth && (n.Authorization = "Basic " + this.basicAuth), t.cache || (t.cache = "no-cache"), t.credentials || (t.credentials = "include");
  }
  setRequestContentType(t, n) {
    t.headers || (t.headers = {});
    let i = t.headers;
    i["Content-Type"] = n;
  }
  setRequestBody(t, n) {
    typeof n == "string" || typeof Blob < "u" && n instanceof Blob || typeof File < "u" && n instanceof File || typeof Uint8Array < "u" && n instanceof Uint8Array ? t.body = n : n && (t.body = JSON.stringify(n));
  }
  handleUnauthenticated(t, n, i) {
    return this.refresh() ? this.request(t, n, i) : (this.clearActiveLogin(), this.onUnauthenticated && this.onUnauthenticated(), Promise.reject(new Error("Unauthenticated")));
  }
  async startPkce() {
    let t = Ot();
    sessionStorage.setItem("pkceState", t);
    let n = Ot();
    sessionStorage.setItem("codeVerifier", n);
    let i = await Qr(n), o = Zt(i).replaceAll("+", "-").replaceAll("/", "_").replaceAll("=", "");
    return sessionStorage.setItem("codeChallenge", o), { codeChallengeMethod: "S256", codeChallenge: o };
  }
  async requestAuthorization(t) {
    let n = await this.ensureCodeChallenge(t ?? {}), i = new URL(this.authorizeUrl);
    i.searchParams.set("response_type", "code"), i.searchParams.set("state", sessionStorage.getItem("pkceState")), i.searchParams.set("client_id", n.clientId ?? this.clientId), i.searchParams.set("redirect_uri", n.redirectUri ?? tn()), i.searchParams.set("code_challenge_method", n.codeChallengeMethod), i.searchParams.set("code_challenge", n.codeChallenge), i.searchParams.set("scope", n.scope ?? "openid profile"), window.location.assign(i.toString());
  }
  processCode(t, n) {
    let i = new URLSearchParams();
    if (i.set("grant_type", "authorization_code"), i.set("code", t), i.set("client_id", (n == null ? void 0 : n.clientId) ?? this.clientId), i.set("redirect_uri", (n == null ? void 0 : n.redirectUri) ?? tn()), typeof sessionStorage < "u") {
      let o = sessionStorage.getItem("codeVerifier");
      o && i.set("code_verifier", o);
    }
    return this.fetchTokens(i);
  }
  refresh() {
    if (this.refreshPromise)
      return this.refreshPromise;
    if (this.refreshToken) {
      let t = new URLSearchParams();
      return t.set("grant_type", "refresh_token"), t.set("client_id", this.clientId), t.set("refresh_token", this.refreshToken), this.refreshPromise = this.fetchTokens(t), this.refreshPromise;
    }
    if (this.clientId && this.clientSecret)
      return this.refreshPromise = this.startClientLogin(this.clientId, this.clientSecret), this.refreshPromise;
  }
  async startClientLogin(t, n) {
    this.clientId = t, this.clientSecret = n;
    let i = new URLSearchParams();
    return i.set("grant_type", "client_credentials"), i.set("client_id", t), i.set("client_secret", n), this.fetchTokens(i);
  }
  async startJwtBearerLogin(t, n, i) {
    this.clientId = t;
    let o = new URLSearchParams();
    return o.set("grant_type", "urn:ietf:params:oauth:grant-type:jwt-bearer"), o.set("client_id", t), o.set("assertion", n), o.set("scope", i), this.fetchTokens(o);
  }
  async startJwtAssertionLogin(t) {
    let n = new URLSearchParams();
    return n.append("grant_type", "client_credentials"), n.append("client_assertion_type", "urn:ietf:params:oauth:client-assertion-type:jwt-bearer"), n.append("client_assertion", t), this.fetchTokens(n);
  }
  setBasicAuth(t, n) {
    this.clientId = t, this.clientSecret = n, this.basicAuth = jr(t + ":" + n);
  }
  async fhircastSubscribe(t, n) {
    if (!(typeof t == "string" && t !== ""))
      throw new d(h("Invalid topic provided. Topic must be a valid string."));
    if (!(typeof n == "object" && Array.isArray(n) && n.length > 0))
      throw new d(h("Invalid events provided. Events must be an array of event names containing at least one event."));
    let i = { channelType: "websocket", mode: "subscribe", topic: t, events: n }, s = (await this.post("/fhircast/STU3", Nt(i), C.FORM_URL_ENCODED))["hub.channel.endpoint"];
    if (!s)
      throw new Error("Invalid response!");
    return i.endpoint = s, i;
  }
  async fhircastUnsubscribe(t) {
    if (!Je(t))
      throw new d(h("Invalid topic or subscriptionRequest. SubscriptionRequest must be an object."));
    if (!(t.endpoint && typeof t.endpoint == "string" && t.endpoint.startsWith("ws")))
      throw new d(h("Provided subscription request must have an endpoint in order to unsubscribe."));
    t.mode = "unsubscribe", await this.post("/fhircast/STU3", Nt(t), C.FORM_URL_ENCODED);
  }
  fhircastConnect(t) {
    return new ze(t);
  }
  async fhircastPublish(t, n, i, o) {
    return Wr(n) ? this.post(`/fhircast/STU3/${t}`, Ft(t, n, i, o), C.JSON) : (Gr(n), this.post(`/fhircast/STU3/${t}`, Ft(t, n, i), C.JSON));
  }
  async invite(t, n) {
    return this.post("admin/projects/" + t + "/invite", n);
  }
  async fetchTokens(t) {
    let n = { method: "POST", headers: { "Content-Type": C.FORM_URL_ENCODED }, body: t.toString(), credentials: "include" }, i = n.headers;
    this.basicAuth && (i.Authorization = `Basic ${this.basicAuth}`);
    let o = await this.fetchWithRetry(this.tokenUrl, n);
    if (!o.ok) {
      this.clearActiveLogin();
      try {
        let a = await o.json();
        throw new d(F(a.error_description));
      } catch (a) {
        throw new d(F("Failed to fetch tokens"), a);
      }
    }
    let s = await o.json();
    return await this.verifyTokens(s), this.getProfile();
  }
  async verifyTokens(t) {
    let n = t.access_token;
    if (Jr(n)) {
      let i = _t(n);
      if (Date.now() >= i.exp * 1e3)
        throw this.clearActiveLogin(), new Error("Token expired");
      if (i.cid) {
        if (i.cid !== this.clientId)
          throw this.clearActiveLogin(), new Error("Token was not issued for this audience");
      } else if (this.clientId && i.client_id !== this.clientId)
        throw this.clearActiveLogin(), new Error("Token was not issued for this audience");
    }
    return this.setActiveLogin({ accessToken: n, refreshToken: t.refresh_token, project: t.project, profile: t.profile });
  }
  setupStorageListener() {
    try {
      window.addEventListener("storage", (t) => {
        (t.key === null || t.key === "activeLogin") && window.location.reload();
      });
    } catch {
    }
  }
  retryCatch(t, n, i) {
    if (i.message === "Failed to fetch" && t === 1 && this.dispatchEvent({ type: "offline" }), t >= n - 1)
      throw i;
  }
};
function so() {
  if (!globalThis.fetch)
    throw new Error("Fetch not available in this environment");
  return globalThis.fetch.bind(globalThis);
}
function tn() {
  return typeof window > "u" ? "" : window.location.protocol + "//" + window.location.host + "/";
}
function rn(r4) {
  return r4.endsWith("/") ? r4 : r4 + "/";
}
function Xe(r4, e) {
  return new URL(e, r4).toString();
}
async function nn(r4) {
  var _a2, _b;
  let e = r4.headers.get("content-location");
  if (e)
    return e;
  let t = r4.headers.get("location");
  if (t)
    return t;
  let n = await r4.json();
  if (ke(n) && ((_b = (_a2 = n.issue) == null ? void 0 : _a2[0]) == null ? void 0 : _b.diagnostics))
    return n.issue[0].diagnostics;
}
function on(r4) {
  var _a2;
  let e = ((_a2 = r4.entry) == null ? void 0 : _a2.map((t) => t.resource)) ?? [];
  return Object.assign(e, { bundle: r4 });
}
var Bc = { aws_ssm_parameter_store: "aws_ssm_parameter_store" };
var sn = "http://unitsofmeasure.org";
var $c = "http://loinc.org";
var jc = "http://snomed.info/sct";
var Qc = "http://www.nlm.nih.gov/research/umls/rxnorm";
var Hc = "http://www.ama-assn.org/go/cpt";
var Kc = "http://hl7.org/fhir/sid/icd-10";
var ao = [...le, "->", "<<", ">>"];
function an(r4) {
  return new K(r4, ue, ao).tokenize();
}
var Lt = class {
  constructor(e) {
    this.parser = e;
    this.structureMap = { resourceType: "StructureMap" };
  }
  parse() {
    var _a2;
    for (this.parser.consume("Symbol", "map"), this.structureMap.url = this.parser.consume("String").value, this.parser.consume("="), this.structureMap.name = this.parser.consume().value; this.parser.hasMore(); ) {
      let e = (_a2 = this.parser.peek()) == null ? void 0 : _a2.value;
      switch (e) {
        case "uses":
          this.parseUses();
          break;
        case "imports":
          this.parseImport();
          break;
        case "group":
          this.parseGroup();
          break;
        case "conceptmap":
          this.parseConceptMap();
          break;
        default:
          throw new Error(`Unexpected token: ${e}`);
      }
    }
    return this.structureMap;
  }
  parseUses() {
    var _a2;
    this.parser.consume("Symbol", "uses");
    let e = {};
    e.url = this.parser.consume("String").value, ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) === "alias" && (this.parser.consume("Symbol", "alias"), e.alias = this.parser.consume("Symbol").value), this.parser.consume("Symbol", "as"), e.mode = this.parser.consume().value, this.structureMap.structure || (this.structureMap.structure = []), this.structureMap.structure.push(e);
  }
  parseImport() {
    this.parser.consume("Symbol", "imports"), this.structureMap.import || (this.structureMap.import = []), this.structureMap.import.push(this.parser.consume("String").value);
  }
  parseGroup() {
    var _a2, _b, _c;
    let e = {};
    this.parser.consume("Symbol", "group"), e.name = this.parser.consume("Symbol").value, e.input = this.parseParameters(), ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) === "extends" && (this.parser.consume("Symbol", "extends"), e.extends = this.parser.consume("Symbol").value), ((_b = this.parser.peek()) == null ? void 0 : _b.value) === "<<" ? (this.parser.consume("<<"), e.typeMode = this.parser.consume().value, ((_c = this.parser.peek()) == null ? void 0 : _c.value) === "+" && (this.parser.consume("+"), e.typeMode = "type-and-types"), this.parser.consume(">>")) : e.typeMode = "none", e.rule = this.parseRules(), this.structureMap.group || (this.structureMap.group = []), this.structureMap.group.push(e);
  }
  parseParameters() {
    var _a2, _b;
    let e = [];
    for (this.parser.consume("("); this.parser.hasMore() && ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) !== ")"; )
      e.push(this.parseParameter()), ((_b = this.parser.peek()) == null ? void 0 : _b.value) === "," && this.parser.consume(",");
    return this.parser.consume(")"), e;
  }
  parseParameter() {
    var _a2;
    let e = {};
    return e.mode = this.parser.consume().value, e.name = this.parser.consume("Symbol").value, ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) === ":" && (this.parser.consume(":"), e.type = this.parser.consume("Symbol").value), e;
  }
  parseRules() {
    var _a2;
    let e = [];
    for (this.parser.consume("{"); this.parser.hasMore() && ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) !== "}"; )
      e.push(this.parseRule());
    return this.parser.consume("}"), e;
  }
  parseRule() {
    var _a2, _b, _c, _d, _e2, _f;
    let e = { source: this.parseRuleSources() };
    return ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) === "->" && (this.parser.consume("->"), e.target = this.parseRuleTargets()), ((_b = this.parser.peek()) == null ? void 0 : _b.value) === "then" && (this.parser.consume("Symbol", "then"), ((_c = this.parser.peek()) == null ? void 0 : _c.id) === "{" ? e.rule = this.parseRules() : e.dependent = this.parseRuleDependents()), ((_d = this.parser.peek()) == null ? void 0 : _d.id) === "String" ? e.name = this.parser.consume().value : e.name = (_f = (_e2 = e.source) == null ? void 0 : _e2[0]) == null ? void 0 : _f.element, this.parser.consume(";"), e;
  }
  parseRuleSources() {
    var _a2;
    let e = [this.parseRuleSource()];
    for (; this.parser.hasMore() && ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) === ","; )
      this.parser.consume(","), e.push(this.parseRuleSource());
    return e;
  }
  parseRuleSource() {
    var _a2, _b, _c, _d, _e2, _f, _g, _h, _i2, _j;
    let e = {}, t = this.parseRuleContext();
    if (t.includes(".")) {
      let n = t.split(".");
      e.context = n[0], e.element = n[1];
    } else
      e.context = t;
    if (this.parser.hasMore() && ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) === ":" && (this.parser.consume(":"), e.type = this.parser.consume().value), this.parser.hasMore() && ((_b = this.parser.peek()) == null ? void 0 : _b.value) === "default" && (this.parser.consume("default"), this.parser.consumeAndParse()), (((_c = this.parser.peek()) == null ? void 0 : _c.value) === "first" || ((_d = this.parser.peek()) == null ? void 0 : _d.value) === "not_first" || ((_e2 = this.parser.peek()) == null ? void 0 : _e2.value) === "last" || ((_f = this.parser.peek()) == null ? void 0 : _f.value) === "not_last" || ((_g = this.parser.peek()) == null ? void 0 : _g.value) === "only_one") && (e.listMode = this.parser.consume().value), ((_h = this.parser.peek()) == null ? void 0 : _h.value) === "as" && (this.parser.consume("Symbol", "as"), e.variable = this.parser.consume().value), ((_i2 = this.parser.peek()) == null ? void 0 : _i2.value) === "where") {
      this.parser.consume("Symbol", "where");
      let n = this.parser.consumeAndParse(m.Arrow);
      e.condition = n.toString();
    }
    if (((_j = this.parser.peek()) == null ? void 0 : _j.value) === "check") {
      this.parser.consume("Symbol", "check");
      let n = this.parser.consumeAndParse(m.Arrow);
      e.check = n.toString();
    }
    return e;
  }
  parseRuleTargets() {
    var _a2;
    let e = [this.parseRuleTarget()];
    for (; this.parser.hasMore() && ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) === ","; )
      this.parser.consume(","), e.push(this.parseRuleTarget());
    return e;
  }
  parseRuleTarget() {
    var _a2, _b, _c, _d, _e2, _f;
    let e = {}, t = this.parseRuleContext();
    if (t.includes(".")) {
      let n = t.split(".");
      e.contextType = "variable", e.context = n[0], e.element = n[1];
    } else
      e.context = t;
    return ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) === "=" && (this.parser.consume("="), this.parseRuleTargetTransform(e)), ((_b = this.parser.peek()) == null ? void 0 : _b.value) === "as" && (this.parser.consume("Symbol", "as"), e.variable = this.parser.consume().value), (((_c = this.parser.peek()) == null ? void 0 : _c.value) === "first" || ((_d = this.parser.peek()) == null ? void 0 : _d.value) === "share" || ((_e2 = this.parser.peek()) == null ? void 0 : _e2.value) === "last" || ((_f = this.parser.peek()) == null ? void 0 : _f.value) === "collate") && (e.listMode = [this.parser.consume().value]), e;
  }
  parseRuleTargetTransform(e) {
    e.transform = "copy";
    let t = this.parser.consumeAndParse(m.As);
    if (t instanceof M)
      this.parseRuleTargetSymbol(e, t);
    else if (t instanceof B)
      this.parseRuleTargetFunction(e, t);
    else if (t instanceof O)
      this.parseRuleTargetLiteral(e, t);
    else
      throw new Error(`Unexpected FHIRPath: ${t}`);
  }
  parseRuleTargetSymbol(e, t) {
    e.parameter = [{ valueId: t.name }];
  }
  parseRuleTargetFunction(e, t) {
    let n = t.name;
    switch (n) {
      case "create":
        e.parameter = [{ valueString: t.args[0].value.value }];
        break;
      case "translate":
        e.parameter = [{}];
        break;
      default:
        throw new Error("Unknown target function: " + n);
    }
  }
  parseRuleTargetLiteral(e, t) {
    switch (t.value.type) {
      case "boolean":
        e.parameter = [{ valueBoolean: t.value.value }];
        break;
      case "decimal":
        e.parameter = [{ valueDecimal: t.value.value }];
        break;
      case "string":
        e.parameter = [{ valueString: t.value.value }];
        break;
      default:
        throw new Error("Unknown target literal type: " + t.value.type);
    }
  }
  parseRuleContext() {
    var _a2;
    let e = this.parser.consume().value;
    for (; ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) === "."; )
      this.parser.consume("."), e += "." + this.parser.consume().value;
    return e;
  }
  parseRuleDependents() {
    let e = this.parser.consumeAndParse(m.Arrow);
    return [{ name: e.name, variable: e.args.map((t) => t.name) }];
  }
  parseConceptMap() {
    var _a2;
    for (; ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) !== "}"; )
      this.parser.consume();
    this.parser.consume("}");
  }
};
var co = de().registerInfix("->", { precedence: m.Arrow }).registerInfix(";", { precedence: m.Semicolon });
function tu(r4) {
  let e = co.construct(an(r4));
  return e.removeComments(), new Lt(e).parse();
}
var uo = [...le, "eq", "ne", "co"];
function cn(r4) {
  return new K(r4, ue, uo, { dateTimeLiterals: true, symbolRegex: /[^\s\])]/ }).tokenize();
}
var Ze = class {
  constructor(e, t, n) {
    this.path = e;
    this.operator = t;
    this.value = n;
  }
};
var et = class {
  constructor(e) {
    this.child = e;
  }
};
var tt = class {
  constructor(e, t, n) {
    this.keyword = e;
    this.left = t;
    this.right = n;
  }
};
var lo = { eq: "eq", ne: "ne", co: "contains", sw: void 0, ew: void 0, gt: "gt", lt: "lt", ge: "ge", le: "le", ap: "ap", sa: "sa", eb: "eb", pr: "missing", po: void 0, ss: void 0, sb: void 0, in: "in", ni: "not-in", re: "eq", identifier: "identifier" };
function po(r4) {
  let e = lo[r4];
  if (!e)
    throw new d(F("Invalid operator: " + r4));
  return e;
}
var Mt = class {
  constructor(e) {
    this.parser = e;
  }
  parse() {
    var _a2, _b, _c;
    let e;
    ((_a2 = this.parser.peek()) == null ? void 0 : _a2.value) === "(" ? (this.parser.consume("("), e = this.parse(), this.parser.consume(")")) : ((_b = this.parser.peek()) == null ? void 0 : _b.value) === "not" ? (this.parser.consume("Symbol", "not"), this.parser.consume("("), e = new et(this.parse()), this.parser.consume(")")) : e = new Ze(this.parser.consume("Symbol").value, po(this.parser.consume("Symbol").value), this.parser.consume().value);
    let t = (_c = this.parser.peek()) == null ? void 0 : _c.value;
    return t === "and" || t === "or" ? (this.parser.consume("Symbol", t), new tt(t, e, this.parse())) : e;
  }
};
var fo = de();
function fu(r4) {
  let e = fo.construct(cn(r4));
  return e.removeComments(), new Mt(e).parse();
}
var W = class {
  constructor(e = "\r", t = "|", n = "^", i = "~", o = "\\", s = "&") {
    this.segmentSeparator = e;
    this.fieldSeparator = t;
    this.componentSeparator = n;
    this.repetitionSeparator = i;
    this.escapeCharacter = o;
    this.subcomponentSeparator = s;
  }
  getMsh1() {
    return this.fieldSeparator;
  }
  getMsh2() {
    return this.componentSeparator + this.repetitionSeparator + this.escapeCharacter + this.subcomponentSeparator;
  }
};
var un = class r {
  constructor(e, t = new W()) {
    this.context = t, this.segments = e;
  }
  get header() {
    return this.segments[0];
  }
  get(e) {
    return this.getSegment(e);
  }
  getAll(e) {
    return this.getAllSegments(e);
  }
  getSegment(e) {
    return typeof e == "number" ? this.segments[e] : this.segments.find((t) => t.name === e);
  }
  getAllSegments(e) {
    return this.segments.filter((t) => t.name === e);
  }
  toString() {
    return this.segments.map((e) => e.toString()).join(this.context.segmentSeparator);
  }
  buildAck() {
    var _a2, _b, _c, _d, _e2, _f;
    let e = /* @__PURE__ */ new Date(), t = this.getSegment("MSH"), n = ((_a2 = t == null ? void 0 : t.getField(3)) == null ? void 0 : _a2.toString()) ?? "", i = ((_b = t == null ? void 0 : t.getField(4)) == null ? void 0 : _b.toString()) ?? "", o = ((_c = t == null ? void 0 : t.getField(5)) == null ? void 0 : _c.toString()) ?? "", s = ((_d = t == null ? void 0 : t.getField(6)) == null ? void 0 : _d.toString()) ?? "", a = ((_e2 = t == null ? void 0 : t.getField(10)) == null ? void 0 : _e2.toString()) ?? "", c = ((_f = t == null ? void 0 : t.getField(12)) == null ? void 0 : _f.toString()) ?? "2.5.1";
    return new r([new ye(["MSH", this.context.getMsh2(), o, s, n, i, ho(e), "", this.buildAckMessageType(t), e.getTime().toString(), "P", c], this.context), new ye(["MSA", "AA", a, "OK"], this.context)]);
  }
  buildAckMessageType(e) {
    let t = e == null ? void 0 : e.getField(9), n = t == null ? void 0 : t.getComponent(2), i = t == null ? void 0 : t.getComponent(3), o = "ACK";
    return n && i ? o = `ACK^${n}^ACK` : n && (o = `ACK^${n}`), o;
  }
  static parse(e) {
    if (!e.startsWith("MSH")) {
      let n = new Error("Invalid HL7 message");
      throw n.type = "entity.parse.failed", n;
    }
    let t = new W("\r", e.charAt(3), e.charAt(4), e.charAt(5), e.charAt(6), e.charAt(7));
    return new r(e.split(/[\r\n]+/).map((n) => ye.parse(n, t)), t);
  }
};
var ye = class r2 {
  constructor(e, t = new W()) {
    this.context = t, Jt(e) ? this.fields = e.map((n) => oe.parse(n, t)) : this.fields = e, this.name = this.fields[0].components[0][0];
  }
  get(e) {
    return this.fields[e];
  }
  getField(e) {
    if (this.name === "MSH") {
      if (e === 1)
        return new oe([[this.context.getMsh1()]], this.context);
      if (e === 2)
        return new oe([[this.context.getMsh2()]], this.context);
      if (e > 2)
        return this.fields[e - 1];
    }
    return this.fields[e];
  }
  getComponent(e, t, n, i = 0) {
    var _a2;
    return ((_a2 = this.getField(e)) == null ? void 0 : _a2.getComponent(t, n, i)) ?? "";
  }
  toString() {
    return this.fields.map((e) => e.toString()).join(this.context.fieldSeparator);
  }
  static parse(e, t = new W()) {
    return new r2(e.split(t.fieldSeparator).map((n) => oe.parse(n, t)), t);
  }
};
var oe = class r3 {
  constructor(e, t = new W()) {
    this.context = t, this.components = e;
  }
  get(e, t, n = 0) {
    return this.getComponent(e + 1, t, n);
  }
  getComponent(e, t, n = 0) {
    let i = this.components[n][e - 1] ?? "";
    return t !== void 0 && (i = i.split(this.context.subcomponentSeparator)[t] ?? ""), i;
  }
  toString() {
    return this.components.map((e) => e.join(this.context.componentSeparator)).join(this.context.repetitionSeparator);
  }
  static parse(e, t = new W()) {
    return new r3(e.split(t.repetitionSeparator).map((n) => n.split(t.componentSeparator)), t);
  }
};
function yu(r4, e) {
  if (!r4)
    return;
  let t = Z(r4.slice(0, 4), 0), n = Z(r4.slice(4, 6), 1) - 1, i = Z(r4.slice(6, 8), 1), o = Z(r4.slice(8, 10), 0), s = Z(r4.slice(10, 12), 0), a = Z(r4.slice(12, 14), 0), c = 0;
  r4.includes(".") && (c = Z(r4.slice(15, 19), 0));
  let f = new Date(Date.UTC(t, n, i, o, s, a, c)), p = mo(r4, e == null ? void 0 : e.tzOffset);
  return p !== 0 && (f = new Date(f.getTime() - p)), f.toISOString();
}
function Z(r4, e) {
  let t = parseInt(r4, 10);
  return isNaN(t) ? e : t;
}
function mo(r4, e) {
  let t = e, n = r4.indexOf("+");
  n !== -1 && (t = r4.slice(n));
  let i = r4.indexOf("-");
  if (i !== -1 && (t = r4.slice(i)), !t)
    return 0;
  let o = t.startsWith("-") ? -1 : 1;
  t = t.slice(1).replace(":", "");
  let s = parseInt(t.slice(0, 2), 10), a = parseInt(t.slice(2, 4), 10);
  return o * (s * 60 * 60 * 1e3 + a * 60 * 1e3);
}
function ho(r4) {
  let e = r4 instanceof Date ? r4 : new Date(r4), n = e.toISOString().replace(/[-:T]/g, "").replace(/(\.\d+)?Z$/, ""), i = e.getUTCMilliseconds();
  return i > 0 && (n += "." + i.toString()), n;
}
function vu(r4) {
  if (!r4)
    throw new d(h("Resource type is null"));
  if (!Ar(r4))
    throw new d(h("Unknown resource type"));
}
function ln(r4, e, t) {
  r4 === null ? t.push(y(e, "Invalid null value")) : Array.isArray(r4) ? yo(r4, e, t) : typeof r4 == "object" && go(r4, e, t);
}
function yo(r4, e, t) {
  for (let n = 0; n < r4.length; n++)
    r4[n] === void 0 ? t.push(y(`${e}[${n}]`, "Invalid undefined value")) : ln(r4[n], `${e}[${n}]`, t);
}
function go(r4, e, t) {
  for (let [n, i] of Object.entries(r4))
    ln(i, `${e}${e ? "." : ""}${n}`, t);
}
function Eu(r4) {
  let e = [];
  return new Promise((t, n) => {
    r4.on("data", (i) => e.push(Buffer.from(i))), r4.on("error", (i) => {
      r4.destroy(), n(i);
    }), r4.on("end", () => {
      t(Buffer.concat(e));
    }), r4.on("close", () => {
      r4.destroy();
    });
  });
}
function qt(r4, e, t, n) {
  new Bt(r4, e, t, n).crawl();
}
var Bt = class {
  constructor(e, t, n, i) {
    this.rootResource = e, this.visitor = t, n ? this.schema = n : this.schema = te(e.resourceType), i ? this.initialPath = i : this.initialPath = e.resourceType;
  }
  crawl() {
    this.crawlObject(T(this.rootResource), this.schema, this.initialPath);
  }
  crawlObject(e, t, n) {
    let i = N(e.value);
    i && this.visitor.onEnterResource && this.visitor.onEnterResource(n, e, t), this.visitor.onEnterObject && this.visitor.onEnterObject(n, e, t);
    for (let o of Object.keys(t.elements))
      this.crawlProperty(e, o, t, `${n}.${o}`);
    this.visitor.onExitObject && this.visitor.onExitObject(n, e, t), i && this.visitor.onExitResource && this.visitor.onExitResource(n, e, t);
  }
  crawlProperty(e, t, n, i) {
    let o = $t(e, t);
    this.visitor.visitProperty && this.visitor.visitProperty(e, t, i, o, n);
    for (let s of o)
      if (s)
        for (let a of be(s))
          this.crawlPropertyValue(a, i);
  }
  crawlPropertyValue(e, t) {
    if (!Ee(e.type.charAt(0))) {
      let n = te(e.type);
      this.crawlObject(e, n, t);
    }
  }
};
function $t(r4, e) {
  if (e === "$this")
    return [r4];
  let [t, ...n] = e.split("."), i = [I(r4, t)];
  for (let o of n) {
    let s = [];
    for (let a of i)
      if (Array.isArray(a))
        for (let c of a)
          s.push(I(c, o));
      else
        a !== void 0 && s.push(I(a, o));
    i = s;
  }
  return i;
}
var dn = { base64Binary: "string", boolean: "boolean", canonical: "string", code: "string", date: "string", dateTime: "string", decimal: "number", id: "string", instant: "string", integer: "number", markdown: "string", oid: "string", positiveInt: "number", string: "string", time: "string", unsignedInt: "number", uri: "string", url: "string", uuid: "string", xhtml: "string", "http://hl7.org/fhirpath/System.String": "string" };
var xo = { base64Binary: /^([A-Za-z\d+/]{4})*([A-Za-z\d+/]{2}==|[A-Za-z\d+/]{3}=)?$/, canonical: /^\S*$/, code: /^[^\s]+( [^\s]+)*$/, date: /^(\d(\d(\d[1-9]|[1-9]0)|[1-9]00)|[1-9]000)(-(0[1-9]|1[0-2])(-(0[1-9]|[1-2]\d|3[0-1]))?)?$/, dateTime: /^(\d(\d(\d[1-9]|[1-9]0)|[1-9]00)|[1-9]000)(-(0[1-9]|1[0-2])(-(0[1-9]|[1-2]\d|3[0-1])(T([01]\d|2[0-3]):[0-5]\d:([0-5]\d|60)(\.\d{1,9})?)?)?(Z|[+-]((0\d|1[0-3]):[0-5]\d|14:00)?)?)?$/, id: /^[A-Za-z0-9\-.]{1,64}$/, instant: /^(\d(\d(\d[1-9]|[1-9]0)|[1-9]00)|[1-9]000)-(0[1-9]|1[0-2])-(0[1-9]|[1-2]\d|3[0-1])T([01]\d|2[0-3]):[0-5]\d:([0-5]\d|60)(\.\d{1,9})?(Z|[+-]((0\d|1[0-3]):[0-5]\d|14:00))$/, markdown: /^[\s\S]+$/, oid: /^urn:oid:[0-2](\.(0|[1-9]\d*))+$/, string: /^[\s\S]+$/, time: /^([01]\d|2[0-3]):[0-5]\d:([0-5]\d|60)(\.\d{1,9})?$/, uri: /^\S*$/, url: /^\S*$/, uuid: /^urn:uuid:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/, xhtml: /.*/ };
var To = { "ele-1": true };
function Wu(r4, e) {
  new jt(r4.resourceType, r4, e).validate();
}
var jt = class {
  constructor(e, t, n) {
    this.issues = [], this.rootResource = t, this.currentResource = [], n ? this.schema = St(n) : this.schema = te(e);
  }
  validate() {
    let e = this.rootResource.resourceType;
    if (!e)
      throw new d(h("Missing resource type"));
    Qt(this.rootResource, e, this.issues), qt(this.rootResource, this, this.schema);
    let t = this.issues;
    if (this.issues = [], t.length > 0)
      throw new d({ resourceType: "OperationOutcome", issue: t });
  }
  onExitObject(e, t, n) {
    this.checkAdditionalProperties(t, n.elements, e);
  }
  onEnterResource(e, t) {
    this.currentResource.push(t.value);
  }
  onExitResource() {
    this.currentResource.pop();
  }
  visitProperty(e, t, n, i, o) {
    var _a2;
    let s = o.elements[t];
    if (!s)
      throw new Error(`Missing element validation schema for ${t}`);
    for (let a of i) {
      if (!this.checkPresence(a, s, n))
        return;
      let c;
      if (s.isArray) {
        if (!Array.isArray(a)) {
          this.issues.push(y(n, "Expected array of values for property"));
          return;
        }
        c = a;
      } else {
        if (Array.isArray(a)) {
          this.issues.push(y(n, "Expected single value for property"));
          return;
        }
        c = [a];
      }
      (c.length < s.min || c.length > s.max) && this.issues.push(y(n, `Invalid number of values: expected ${s.min}..${Number.isFinite(s.max) ? s.max : "*"}, but found ${c.length}`)), pn(a, s) || this.issues.push(y(n, "Value did not match expected pattern"));
      let f = s.slicing ? Object.fromEntries(s.slicing.slices.map((p) => [p.name, 0])) : void 0;
      for (let p of c) {
        this.constraintsCheck(p, s, n), this.checkPropertyValue(p, n);
        let q = bo(p, s.slicing);
        q && f && (f[q] += 1);
      }
      this.validateSlices((_a2 = s.slicing) == null ? void 0 : _a2.slices, f, n);
    }
  }
  checkPresence(e, t, n) {
    return e === void 0 ? (t.min > 0 && this.issues.push(y(n, "Missing required property")), false) : E(e) ? (this.issues.push(y(n, "Invalid empty value")), false) : true;
  }
  checkPropertyValue(e, t) {
    Ee(e.type.charAt(0)) && this.validatePrimitiveType(e, t);
  }
  validateSlices(e, t, n) {
    if (!(!e || !t))
      for (let i of e) {
        let o = t[i.name];
        (o < i.min || o > i.max) && this.issues.push(y(n, `Incorrect number of values provided for slice '${i.name}': expected ${i.min}..${Number.isFinite(i.max) ? i.max : "*"}, but found ${o}`));
      }
  }
  checkAdditionalProperties(e, t, n) {
    let i = e.value;
    if (i)
      for (let o of Object.keys(i))
        o !== "resourceType" && !(o in t) && !(o.startsWith("_") && o.slice(1) in t) && !So(e, o, t) && this.issues.push(y(`${n}.${o}`, `Invalid additional property "${o}"`));
  }
  constraintsCheck(e, t, n) {
    let i = t.constraints;
    if (i) {
      for (let o of i)
        if (o.severity === "error" && !(o.key in To) && !this.isExpressionTrue(o, e, n)) {
          this.issues.push(gr(n, o));
          return;
        }
    }
  }
  isExpressionTrue(e, t, n) {
    try {
      let i = pe(e.expression, [t], { context: t, resource: T(this.currentResource[this.currentResource.length - 1]), rootResource: T(this.rootResource), ucum: T(sn) });
      return i.length === 1 && i[0].value === true;
    } catch (i) {
      return this.issues.push(xr(n, "Error evaluating invariant expression", i, { fhirpath: e.expression })), false;
    }
  }
  validatePrimitiveType(e, t) {
    let [n, i] = Ro(e);
    if (n) {
      let { type: o, value: s } = n;
      if (!(o in dn)) {
        this.issues.push(y(t, `Invalid JSON type: ${o} is not a valid FHIR type`));
        return;
      }
      let a = dn[o];
      if (typeof s !== a) {
        s !== null && this.issues.push(y(t, `Invalid JSON type: expected ${a}, but got ${typeof s}`));
        return;
      }
      a === "string" ? this.validateString(s, o, t) : a === "number" && this.validateNumber(s, o, t);
    }
    i && qt(i.value, this, te("Element"), t);
  }
  validateString(e, t, n) {
    if (!e.trim()) {
      this.issues.push(y(n, "String must contain non-whitespace content"));
      return;
    }
    let i = xo[t];
    i && !i.exec(e) && this.issues.push(y(n, "Invalid " + t + " format"));
  }
  validateNumber(e, t, n) {
    isNaN(e) || !isFinite(e) ? this.issues.push(y(n, "Invalid numeric value")) : vo(t) && !Number.isInteger(e) ? this.issues.push(y(n, "Expected number to be an integer")) : t === u.positiveInt && e <= 0 ? this.issues.push(y(n, "Expected number to be positive")) : t === u.unsignedInt && e < 0 && this.issues.push(y(n, "Expected number to be non-negative"));
  }
};
function vo(r4) {
  return r4 === u.integer || r4 === u.positiveInt || r4 === u.unsignedInt;
}
function So(r4, e, t) {
  e.startsWith("_") && (e = e.slice(1));
  let n = e.split(/(?=[A-Z])/g), i = "";
  for (let o of n)
    if (i += o, t[i + "[x]"])
      return !!I(r4, i);
  return false;
}
function Qt(r4, e, t) {
  var _a2;
  for (let [n, i] of Object.entries(r4)) {
    let o = `${e}.${n}`, s = n.startsWith("_") ? n.slice(1) : `_${n}`;
    if (i === null)
      t.push(y(o, "Invalid null value"));
    else if (Array.isArray(i))
      for (let a = 0; a < i.length; a++)
        i[a] === void 0 ? t.push(y(`${o}[${a}]`, "Invalid undefined value")) : i[a] === null && !((_a2 = r4[s]) == null ? void 0 : _a2[a]) ? t.push(y(`${o}[${a}]`, "Invalid null value")) : i[a] && Qt(i[a], `${o}[${a}]`, t);
    else
      typeof i == "object" && Qt(i, o, t);
  }
}
function pn(r4, e) {
  return e.pattern && !Se(r4, e.pattern) ? false : !(e.fixed && !ve(r4, e.fixed));
}
function Eo(r4, e, t) {
  if (Array.isArray(r4))
    return false;
  let n = t.elements[e.path], i = t.type;
  switch (e.type) {
    case "value":
    case "pattern":
      if (!r4 || !n)
        return false;
      if (pn(r4, n))
        return true;
      break;
    case "type":
      return !r4 || !(i == null ? void 0 : i.length) ? false : i.some((o) => o.code === r4.type);
  }
  return false;
}
function bo(r4, e) {
  if (e) {
    for (let t of e.slices)
      if (e.discriminator.every((n) => {
        var _a2;
        return (_a2 = be($t(r4, n.path))) == null ? void 0 : _a2.some((i) => Eo(i, n, t));
      }))
        return t.name;
  }
}
function Ro(r4) {
  if (typeof r4.value != "object" || !r4.value)
    return [r4, void 0];
  let e = r4.value.valueOf();
  if (e === r4.value)
    return [void 0, { type: "Element", value: r4.value }];
  let t = new Set(Object.keys(e)), n = Object.entries(r4.value).filter(([o, s]) => !t.has(o)), i = n.length > 0 ? Object.fromEntries(n) : void 0;
  return [{ type: r4.type, value: e }, { type: "Element", value: i }];
}

export {
  ge,
  $,
  xe,
  rt,
  G,
  se,
  Kt,
  wo,
  mn,
  hn,
  Io,
  ko,
  Te,
  Oo,
  Vo,
  Do,
  No,
  Fo,
  _o,
  Uo,
  zt,
  E,
  ve,
  Se,
  it,
  Lo,
  j,
  Jt,
  Xt,
  Zt,
  P,
  Ee,
  nt,
  Mo,
  Bo,
  qo,
  tr,
  $o,
  jo,
  Qo,
  Ho,
  Cn,
  wn,
  Ko,
  be,
  ot,
  Wo,
  Jo,
  Re,
  Yo,
  Xo,
  at,
  Zo,
  In,
  st,
  es,
  ts,
  rs,
  z,
  ns,
  Nn,
  Fn,
  _n,
  os,
  Bn,
  nr,
  l,
  T,
  L,
  D,
  I,
  Pe,
  ct,
  ut,
  ur,
  lt,
  Qn,
  Ae,
  Hn,
  b,
  lr,
  ps,
  fs,
  ms,
  mr,
  hs,
  ys,
  gs,
  xs,
  Ts,
  F,
  h,
  hr,
  ke,
  yt,
  vs,
  Ss,
  Es,
  bs,
  Rs,
  Ps,
  d,
  Oe,
  Kn,
  yr,
  Wn,
  y,
  gr,
  xr,
  St,
  Er,
  Gn,
  br,
  Rr,
  Pr,
  te,
  Ar,
  Ns,
  u,
  qs,
  bt,
  vt,
  Zn,
  Et,
  $s,
  js,
  Qs,
  Hs,
  Ce,
  N,
  ae,
  k,
  wr,
  Ve,
  O,
  M,
  De,
  Ne,
  J,
  v,
  R,
  Fe,
  _e,
  Ue,
  H,
  ne,
  Le,
  Me,
  Be,
  qe,
  Y,
  $e,
  je,
  Qe,
  He,
  B,
  X,
  K,
  m,
  de,
  Rt,
  ie,
  pe,
  kr,
  Or,
  Dr,
  Ia,
  Fa,
  hi,
  _a,
  Ur,
  Ua,
  wt,
  xi,
  La,
  Ma,
  Mr,
  Ni,
  Fi,
  _i,
  Wa,
  Li,
  Ga,
  Mi,
  za,
  $r,
  jr,
  Ot,
  Qr,
  me,
  Bi,
  $i,
  nc,
  We,
  C,
  he,
  Ge,
  Vt,
  Hi,
  Dt,
  Wr,
  Gr,
  Ki,
  Wi,
  zr,
  Nt,
  Je,
  Ft,
  ze,
  Jr,
  _t,
  Yr,
  w,
  Ye,
  Ut,
  Lc,
  Xi,
  ro,
  no,
  io,
  oo,
  en,
  Bc,
  sn,
  $c,
  jc,
  Qc,
  Hc,
  Kc,
  tu,
  Ze,
  et,
  tt,
  fu,
  W,
  un,
  ye,
  oe,
  yu,
  ho,
  vu,
  ln,
  Eu,
  qt,
  $t,
  dn,
  Wu
};
//# sourceMappingURL=chunk-LA5DQH65.js.map
